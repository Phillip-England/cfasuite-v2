<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CFA Suite Admin</title>
  <meta name="csrf-token" content="{{ .CSRF }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", sans-serif;
    }

    /* Card / panel */
    .panel {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }

    /* Headings */
    .panel-title {
      margin: 0 0 0.25rem;
      font: 700 1.375rem/1.3 "Space Grotesk", sans-serif;
      color: var(--fg);
    }

    .panel-desc {
      margin: 0 0 1.25rem;
      font-size: 0.875rem;
      color: var(--muted-fg);
    }

    /* Submenu tab buttons */
    .submenu {
      display: flex;
      gap: 0.5rem;
      margin: 0 0 1rem;
      flex-wrap: wrap;
    }

    .submenu-btn {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
      font-weight: 500;
      background-color: transparent;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      cursor: pointer;
      font-family: inherit;
      color: var(--muted-fg);
      transition: 150ms;
    }

    .submenu-btn:hover {
      background-color: var(--muted);
      color: var(--fg);
    }

    .submenu-btn.active {
      background-color: var(--fg);
      color: var(--bg);
      border-color: var(--fg);
    }

    /* Tab panels */
    .tab-panel[hidden] { display: none; }

    /* Form layout */
    form {
      display: grid;
      gap: 1rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.875rem;
    }

    label {
      display: grid;
      gap: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--fg);
    }

    label.required > .label-text::after {
      content: " *";
      color: var(--danger);
      font-weight: 700;
    }

    label.required.required-complete > .label-text::after {
      content: "";
    }

    label.required {
      display: block;
    }

    label.required > input,
    label.required > div {
      margin-top: 0.375rem;
    }

    input,
    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      min-height: 2.375rem;
      padding: 0.5rem 0.75rem;
      font: 500 0.875rem/1.25 "Manrope", sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      transition: border-color 140ms ease, box-shadow 140ms ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0,79,113,.15);
    }

    html.dark input,
    html.dark select {
      background-color: #18181b;
      border-color: var(--border);
      color: var(--fg);
    }

    html.dark input:focus,
    html.dark select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0,79,113,.15);
    }

    /* Primary submit button */
    button[type="submit"],
    #submit-btn {
      background-color: var(--primary);
      color: var(--primary-fg);
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font: 600 0.875rem/1.25 inherit;
      cursor: pointer;
      min-height: 2.375rem;
      transition: opacity 150ms;
    }

    button[type="submit"]:hover { opacity: 0.9; }
    button[type="submit"]:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Status messages */
    .status {
      min-height: 1.3em;
      margin: 0;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status.ok  { color: var(--success); }
    .status.error { color: var(--danger); }

    /* Meta note */
    .meta {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      color: var(--muted-fg);
      font-size: 0.8125rem;
    }

    /* Locations section */
    .locations {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border);
    }

    .locations h2 {
      margin: 0 0 0.75rem;
      font: 700 1rem/1.3 "Space Grotesk", sans-serif;
      color: var(--fg);
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 560px;
      background-color: var(--bg);
    }

    html.dark table { background-color: #18181b; }

    th, td {
      text-align: left;
      padding: 0.625rem 0.875rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
    }

    tbody tr:last-child td { border-bottom: 0; }

    th {
      font: 600 0.75rem/1 "Space Grotesk", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted-fg);
      background-color: var(--muted);
    }

    html.dark th { background-color: #18181b; }

    /* Location link */
    .location-link {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
    }

    .location-link:hover { text-decoration: underline; }

    /* Action buttons in table */
    .actions {
      display: flex;
      gap: 0.5rem;
    }

    .table-btn {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      font-size: 0.8125rem;
      font-weight: 500;
      background-color: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 0.3125rem;
      cursor: pointer;
      font-family: inherit;
      transition: 150ms;
    }

    .table-btn:hover { background-color: var(--muted); }

    .table-btn.danger { color: var(--danger); border-color: var(--danger); }
    .table-btn.danger:hover { background-color: rgba(220,38,38,.08); }

    /* Pager */
    .pager {
      margin-top: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      color: var(--muted-fg);
    }

    .pager a {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
    }

    .pager a:hover { text-decoration: underline; }

    /* Inline code */
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.8125rem;
      background: var(--muted);
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      padding: 0.125rem 0.375rem;
    }

    @media (max-width: 640px) {
      .grid-2 { grid-template-columns: 1fr; }
      .panel { padding: 1.125rem; }
    }
  </style>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors">

  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Locations</a>
      </nav>
      <div class="flex items-center gap-2 shrink-0">
        <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
        <button id="theme-toggle" type="button" aria-label="Toggle theme" class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <button id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-mobile" class="md:hidden h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <span class="sr-only">Open menu</span>
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </button>
      </div>
    </div>
    <div id="nav-mobile" class="hidden md:hidden border-t border-zinc-200 dark:border-zinc-800 px-4 py-2 bg-white dark:bg-zinc-950 flex-col gap-1">
      <a href="/admin" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Locations</a>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto w-full max-w-[800px]">

      <section class="panel">
        <h1 class="panel-title">Chick-fil-A Locations</h1>
        <p class="panel-desc">Use the submenu to create a location or view existing locations.</p>

        <div class="submenu" role="tablist" aria-label="Location admin sections">
          <button type="button" class="submenu-btn active" data-panel-target="view" role="tab" aria-selected="true">View Locations</button>
          <button type="button" class="submenu-btn" data-panel-target="create" role="tab" aria-selected="false">Create Location</button>
        </div>

        <p id="status" class="status" aria-live="polite"></p>

        <section class="tab-panel" data-panel-name="create" hidden>
          <form id="create-location-form">
            <p class="meta" style="margin-top:0; padding-top:0; border-top:none;">All fields are required. Asterisks remain until each required field is complete.</p>
            <div class="grid-2">
              <label class="required">
                <span class="label-text">Location Name</span>
                <input id="name" name="name" type="text" placeholder="Example: Nashville Downtown" required>
              </label>
              <label class="required">
                <span class="label-text">Location Number</span>
                <input id="number" name="number" type="text" placeholder="Example: TN-1024" required>
              </label>
              <label class="required">
                <span class="label-text">Location Login Email</span>
                <input id="email" name="email" type="email" placeholder="Auto-generated from location number" readonly required>
              </label>
              <label class="required">
                <span class="label-text">Location Phone</span>
                <div style="display:grid;grid-template-columns:96px auto 96px auto 1fr;gap:8px;align-items:center;">
                  <input id="phone_1" name="phone_1" type="text" inputmode="numeric" maxlength="3" pattern="[0-9]{3}" placeholder="615" required>
                  <span style="font-weight:700;color:var(--muted-fg);text-align:center;">-</span>
                  <input id="phone_2" name="phone_2" type="text" inputmode="numeric" maxlength="3" pattern="[0-9]{3}" placeholder="555" required>
                  <span style="font-weight:700;color:var(--muted-fg);text-align:center;">-</span>
                  <input id="phone_3" name="phone_3" type="text" inputmode="numeric" maxlength="4" pattern="[0-9]{4}" placeholder="1234" required>
                </div>
              </label>
              <label class="required">
                <span class="label-text">Owner/Operator</span>
                <input id="employer_rep_signature" name="employer_rep_signature" type="text" maxlength="120" placeholder="Example: Jane Smith, HR Manager" required>
              </label>
              <label class="required">
                <span class="label-text">Business or Organization Name</span>
                <input id="business_name" name="business_name" type="text" placeholder="Example: Chick-fil-A Downtown Nashville LLC" required>
              </label>
              <label class="required">
                <span class="label-text">Business Street Address</span>
                <input id="business_street" name="business_street" type="text" placeholder="Example: 123 Main St" required>
              </label>
              <label class="required">
                <span class="label-text">Business City</span>
                <input id="business_city" name="business_city" type="text" placeholder="Example: Nashville" required>
              </label>
              <label class="required">
                <span class="label-text">Business State</span>
                <select id="business_state" name="business_state" required>
                  <option value="">Select state</option>
                  <option value="AL">Alabama (AL)</option>
                  <option value="AK">Alaska (AK)</option>
                  <option value="AZ">Arizona (AZ)</option>
                  <option value="AR">Arkansas (AR)</option>
                  <option value="CA">California (CA)</option>
                  <option value="CO">Colorado (CO)</option>
                  <option value="CT">Connecticut (CT)</option>
                  <option value="DE">Delaware (DE)</option>
                  <option value="FL">Florida (FL)</option>
                  <option value="GA">Georgia (GA)</option>
                  <option value="HI">Hawaii (HI)</option>
                  <option value="ID">Idaho (ID)</option>
                  <option value="IL">Illinois (IL)</option>
                  <option value="IN">Indiana (IN)</option>
                  <option value="IA">Iowa (IA)</option>
                  <option value="KS">Kansas (KS)</option>
                  <option value="KY">Kentucky (KY)</option>
                  <option value="LA">Louisiana (LA)</option>
                  <option value="ME">Maine (ME)</option>
                  <option value="MD">Maryland (MD)</option>
                  <option value="MA">Massachusetts (MA)</option>
                  <option value="MI">Michigan (MI)</option>
                  <option value="MN">Minnesota (MN)</option>
                  <option value="MS">Mississippi (MS)</option>
                  <option value="MO">Missouri (MO)</option>
                  <option value="MT">Montana (MT)</option>
                  <option value="NE">Nebraska (NE)</option>
                  <option value="NV">Nevada (NV)</option>
                  <option value="NH">New Hampshire (NH)</option>
                  <option value="NJ">New Jersey (NJ)</option>
                  <option value="NM">New Mexico (NM)</option>
                  <option value="NY">New York (NY)</option>
                  <option value="NC">North Carolina (NC)</option>
                  <option value="ND">North Dakota (ND)</option>
                  <option value="OH">Ohio (OH)</option>
                  <option value="OK">Oklahoma (OK)</option>
                  <option value="OR">Oregon (OR)</option>
                  <option value="PA">Pennsylvania (PA)</option>
                  <option value="RI">Rhode Island (RI)</option>
                  <option value="SC">South Carolina (SC)</option>
                  <option value="SD">South Dakota (SD)</option>
                  <option value="TN">Tennessee (TN)</option>
                  <option value="TX">Texas (TX)</option>
                  <option value="UT">Utah (UT)</option>
                  <option value="VT">Vermont (VT)</option>
                  <option value="VA">Virginia (VA)</option>
                  <option value="WA">Washington (WA)</option>
                  <option value="WV">West Virginia (WV)</option>
                  <option value="WI">Wisconsin (WI)</option>
                  <option value="WY">Wyoming (WY)</option>
                  <option value="DC">District of Columbia (DC)</option>
                </select>
              </label>
              <label class="required">
                <span class="label-text">Business EIN</span>
                <div style="display:grid;grid-template-columns:96px auto 1fr;gap:8px;align-items:center;">
                  <input id="business_ein_1" name="business_ein_1" type="text" inputmode="numeric" maxlength="2" pattern="[0-9]{2}" placeholder="12" required>
                  <span style="font-weight:700;color:var(--muted-fg);text-align:center;">-</span>
                  <input id="business_ein_2" name="business_ein_2" type="text" inputmode="numeric" maxlength="7" pattern="[0-9]{7}" placeholder="3456789" required>
                </div>
              </label>
            </div>

            <button id="submit-btn" type="submit">Create Location</button>
          </form>
        </section>

        <section class="tab-panel" data-panel-name="view">
          <section class="locations">
            <h2>Locations ({{ .TotalCount }})</h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Number</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  {{ if .Locations }}
                    {{ range .Locations }}
                      <tr>
                        <td><a class="location-link" href="/admin/locations/{{ .Number }}">{{ .Name }}</a></td>
                        <td>{{ .Number }}</td>
                        <td>{{ if .Email }}{{ .Email }}{{ else }}-{{ end }}</td>
                      </tr>
                    {{ end }}
                  {{ else }}
                    <tr>
                      <td colspan="3">No locations yet.</td>
                    </tr>
                  {{ end }}
                </tbody>
              </table>
            </div>

            <div class="pager">
              <div>
                {{ if .HasPrev }}
                  <a href="/admin?page={{ .PrevPage }}#view">Previous</a>
                {{ end }}
              </div>
              <div>Page {{ .Page }}</div>
              <div>
                {{ if .HasNext }}
                  <a href="/admin?page={{ .NextPage }}#view">Next</a>
                {{ end }}
              </div>
            </div>
          </section>
        </section>
      </section>

    </div>
  </div>

  <script>
    const form = document.getElementById("create-location-form");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submit-btn");
    const endpoint = "/admin/locations";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const submenuButtons = Array.from(document.querySelectorAll(".submenu-btn"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));
    const numberInput = document.getElementById("number");
    const emailInput = document.getElementById("email");
    const requiredInputs = Array.from(document.querySelectorAll("#create-location-form input[required], #create-location-form select[required]"));

    function syncAutoEmail() {
      if (!numberInput || !emailInput) return;
      const number = (numberInput.value || "").trim().toLowerCase();
      emailInput.value = number ? `${number}@chick-fil-a.com` : "";
    }
    if (numberInput && emailInput) {
      numberInput.addEventListener("input", syncAutoEmail);
      syncAutoEmail();
    }

    function setFieldState(input, isValid) {
      if (!input) return;
      const label = input.closest("label.required");
      if (!label) return;
      const labelRequiredInputs = Array.from(label.querySelectorAll("input[required], select[required]"));
      const labelComplete = labelRequiredInputs.length > 0 && labelRequiredInputs.every((el) => isFieldValid(el));
      label.classList.toggle("required-complete", labelComplete);
    }

    function isFieldValid(input) {
      if (!input) return false;
      const value = (input.value || "").trim();
      if (value === "") return false;
      if (input.id === "phone_1" || input.id === "phone_2") return value.length === 3;
      if (input.id === "phone_3") return value.length === 4;
      if (input.id === "business_ein_1") return value.length === 2;
      if (input.id === "business_ein_2") return value.length === 7;
      if (input.id === "email") return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      return true;
    }

    function validateAllFields() {
      let allValid = true;
      requiredInputs.forEach((input) => {
        const valid = isFieldValid(input);
        setFieldState(input, valid);
        if (!valid) allValid = false;
      });
      return allValid;
    }

    requiredInputs.forEach((input) => {
      input.addEventListener("input", () => {
        if (input.id === "number") syncAutoEmail();
        setFieldState(input, isFieldValid(input));
        if (input.id === "number" && emailInput) {
          setFieldState(emailInput, isFieldValid(emailInput));
        }
      });
      input.addEventListener("blur", () => setFieldState(input, isFieldValid(input)));
      setFieldState(input, isFieldValid(input));
    });

    function setActivePanel(panelName, pushHash = true) {
      tabPanels.forEach((panel) => {
        panel.hidden = panel.dataset.panelName !== panelName;
      });
      submenuButtons.forEach((btn) => {
        const active = btn.dataset.panelTarget === panelName;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-selected", active ? "true" : "false");
      });
      if (pushHash) {
        if (window.location.hash !== `#${panelName}`) {
          window.location.hash = panelName;
        }
      }
    }

    submenuButtons.forEach((btn) => {
      btn.addEventListener("click", () => setActivePanel(btn.dataset.panelTarget || "view"));
    });

    const initialPanel = (window.location.hash || "").replace("#", "");
    if (initialPanel === "create") {
      setActivePanel("create", false);
    } else {
      setActivePanel("view", false);
    }

    if (form && statusEl && submitBtn) form.addEventListener("submit", async (event) => {
      event.preventDefault();

      statusEl.textContent = "";
      statusEl.className = "status";
      submitBtn.disabled = true;

      if (!validateAllFields()) {
        statusEl.textContent = "Please complete all required fields.";
        statusEl.classList.add("error");
        submitBtn.disabled = false;
        return;
      }
      const einPart1 = (document.getElementById("business_ein_1").value || "").replace(/\D+/g, "").slice(0, 2);
      const einPart2 = (document.getElementById("business_ein_2").value || "").replace(/\D+/g, "").slice(0, 7);
      const phonePart1 = (document.getElementById("phone_1").value || "").replace(/\D+/g, "").slice(0, 3);
      const phonePart2 = (document.getElementById("phone_2").value || "").replace(/\D+/g, "").slice(0, 3);
      const phonePart3 = (document.getElementById("phone_3").value || "").replace(/\D+/g, "").slice(0, 4);
      const payload = {
        name: document.getElementById("name").value.trim(),
        number: document.getElementById("number").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: `${phonePart1}-${phonePart2}-${phonePart3}`,
        employerRepSignature: document.getElementById("employer_rep_signature").value.trim(),
        businessName: document.getElementById("business_name").value.trim(),
        businessStreet: document.getElementById("business_street").value.trim(),
        businessCity: document.getElementById("business_city").value.trim(),
        businessState: document.getElementById("business_state").value.trim(),
        businessEin: `${einPart1}-${einPart2}`
      };

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = result.error || "Unable to create location.";
          throw new Error(message);
        }

        const restaurantUsername = (result.restaurantUsername || "").trim();
        const restaurantPassword = (result.restaurantPassword || "").trim();
        if (restaurantUsername && restaurantPassword) {
          statusEl.textContent = `Location ${payload.number} (${payload.name}) created. Restaurant login: ${restaurantUsername} | Initial password: ${restaurantPassword}`;
        } else {
          statusEl.textContent = `Location ${payload.number} (${payload.name}) created successfully.`;
        }
        statusEl.classList.add("ok");
        form.reset();
        syncAutoEmail();
        window.setTimeout(() => { window.location.hash = 'view'; window.location.reload(); }, 250);
      } catch (error) {
        statusEl.textContent = error.message || "Unexpected error occurred.";
        statusEl.classList.add("error");
      } finally {
        submitBtn.disabled = false;
      }
    });

    const ein1 = document.getElementById("business_ein_1");
    const ein2 = document.getElementById("business_ein_2");
    const phone1 = document.getElementById("phone_1");
    const phone2 = document.getElementById("phone_2");
    const phone3 = document.getElementById("phone_3");
    const digitsOnly = (value, maxLen) => (value || "").replace(/\D+/g, "").slice(0, maxLen);
    if (ein1 && ein2) {
      ein1.addEventListener("input", () => {
        ein1.value = digitsOnly(ein1.value, 2);
        if (ein1.value.length === 2) ein2.focus();
      });
      ein2.addEventListener("input", () => {
        ein2.value = digitsOnly(ein2.value, 7);
      });
      ein2.addEventListener("keydown", (event) => {
        if (event.key === "Backspace" && ein2.value === "") {
          ein1.focus();
        }
      });
    }
    if (phone1 && phone2 && phone3) {
      phone1.addEventListener("input", () => {
        phone1.value = digitsOnly(phone1.value, 3);
        if (phone1.value.length === 3) phone2.focus();
        setFieldState(phone1, isFieldValid(phone1));
      });
      phone2.addEventListener("input", () => {
        phone2.value = digitsOnly(phone2.value, 3);
        if (phone2.value.length === 3) phone3.focus();
        setFieldState(phone2, isFieldValid(phone2));
      });
      phone3.addEventListener("input", () => {
        phone3.value = digitsOnly(phone3.value, 4);
        setFieldState(phone3, isFieldValid(phone3));
      });
      phone2.addEventListener("keydown", (event) => {
        if (event.key === "Backspace" && phone2.value === "") {
          phone1.focus();
        }
      });
      phone3.addEventListener("keydown", (event) => {
        if (event.key === "Backspace" && phone3.value === "") {
          phone2.focus();
        }
      });
    }

  </script>

  <script>
    (function () {
      var storageKey = "cfasuite-theme";
      var root = document.documentElement;
      var toggle = document.getElementById("theme-toggle");
      var navToggle = document.getElementById("nav-toggle");
      var navMobile = document.getElementById("nav-mobile");
      if (toggle) {
        toggle.addEventListener("click", function () {
          var isDark = root.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
        });
      }
      if (navToggle && navMobile) {
        navToggle.addEventListener("click", function () {
          var expanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", expanded ? "false" : "true");
          navMobile.classList.toggle("hidden", expanded);
          navMobile.style.display = expanded ? "" : "flex";
        });
      }
    })();
  </script>

</body>
</html>
