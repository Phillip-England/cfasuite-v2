<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/app.css">
  <script defer src="/assets/upload-drop.js"></script>
  <title>Upload Profile Photo</title>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --line: #e4e4e7;
      --ink: #09090b;
      --muted: #71717a;
      --accent: #004f71;
      --accent-hover: #003a55;
      --accent-fg: #ffffff;
      --soft: #f4f4f5;
      --shadow: 0 16px 34px rgba(15, 23, 42, 0.08);
    }
    html.dark {
      --bg: #000000;
      --card: #09090b;
      --line: #27272a;
      --ink: #f4f4f5;
      --muted: #a1a1aa;
      --accent: #004f71;
      --accent-hover: #2f8fb8;
      --accent-fg: #f4f4f5;
      --soft: #18181b;
      --shadow: 0 16px 34px rgba(0, 0, 0, 0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 14px;
      background:
        radial-gradient(52rem 28rem at 110% -10%, rgba(249, 115, 22, 0.12) 0, transparent 55%),
        radial-gradient(40rem 22rem at -15% 120%, rgba(14, 165, 233, 0.08) 0, transparent 52%),
        var(--bg);
      color: var(--ink);
      font-family: "Manrope", "Segoe UI", sans-serif;
    }
    .card {
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px 16px 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    h1 { margin: 0 0 4px; font-size: clamp(1.3rem, 5vw, 1.65rem); line-height: 1.15; }
    .sub { margin: 0 0 12px; color: var(--muted); font-size: 0.9rem; }
    .msg { margin: 0 0 10px; font-weight: 700; font-size: 0.9rem; }
    .msg.error { color: #dc2626; }
    .msg.ok { color: #16a34a; }

    form { display: grid; gap: 11px; }
    .field { display: grid; gap: 6px; }
    .label { font-size: 0.8rem; font-weight: 800; letter-spacing: 0.04em; text-transform: uppercase; color: var(--muted); }

    input[type="file"], input[type="range"] {
      width: 100%;
    }
    input[type="file"] {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: var(--card);
      color: var(--ink);
      min-height: 44px;
    }

    .preview-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px;
    }
    .preview-box {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--soft);
      padding: 8px;
      display: grid;
      gap: 6px;
    }
    .preview-box.crop-result-box { display: none; }
    .preview-box.crop-result-box.is-active { display: grid; }
    .preview-label {
      font-size: 0.74rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .preview {
      width: 100%;
      max-height: 320px;
      border-radius: 10px;
      border: 1px solid var(--line);
      object-fit: contain;
      background: var(--card);
      display: block;
    }
    .crop-stage {
      position: relative;
      width: 100%;
    }
    .crop-selection {
      position: absolute;
      border: 2px solid #fff;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.38);
      border-radius: 8px;
      cursor: move;
      touch-action: none;
      display: none;
    }
    .crop-selection.is-active { display: block; }
    .crop-selection.is-locked { box-shadow: none; cursor: default; }
    .crop-selection.is-locked .crop-handle { display: none; }
    .crop-handle {
      position: absolute;
      width: 18px;
      height: 18px;
      right: -9px;
      bottom: -9px;
      border-radius: 999px;
      border: 2px solid #fff;
      background: var(--accent);
      cursor: nwse-resize;
      touch-action: none;
    }

    .crop-tools { display: none; gap: 10px; position: relative; z-index: 20; }
    .crop-tools.is-active { display: grid; }
    .button-row { display: grid; gap: 8px; }
    .btn {
      border: 1px solid transparent;
      border-radius: 10px;
      min-height: 44px;
      padding: 10px 12px;
      background: var(--accent);
      color: var(--accent-fg);
      font: 800 0.94rem/1 "Manrope", sans-serif;
      cursor: pointer;
      transition: background-color 140ms ease, color 140ms ease, border-color 140ms ease;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn.secondary {
      border-color: var(--line);
      background: var(--card);
      color: var(--ink);
    }
    .btn.secondary:hover {
      background: var(--soft);
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    html.dark input[type="file"],
    html.dark .card {
      background-color: #09090b !important;
      color: var(--ink) !important;
      border-color: var(--line) !important;
    }

    @media (min-width: 720px) {
      body { padding: 22px; }
      .card { padding: 20px; }
      .button-row { grid-template-columns: 1fr 1fr 1fr; }
    }
</style>
  <script>
    (function () {
      const stored = localStorage.getItem("cfasuite-theme");
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>

</head>
<body class="min-h-screen pt-20 bg-white text-zinc-900 dark:bg-black dark:text-zinc-100 transition-colors duration-200">
  <button id="theme-toggle" type="button" aria-label="Toggle theme" class="fixed top-3 right-3 z-[1200] h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-white/90 dark:bg-zinc-900/90 text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors backdrop-blur">
    <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
  </button>
  <nav id="app-nav" class="fixed top-3 left-3 right-20 z-[1100]">
    <div class="mx-auto max-w-6xl rounded-xl border border-zinc-200/80 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur px-3 py-2">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm font-extrabold tracking-[0.06em] uppercase text-zinc-800 dark:text-zinc-100">CFA Suite</div>
        <button id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-links" class="md:hidden inline-flex items-center justify-center rounded-md border border-zinc-300 dark:border-zinc-700 p-2 text-zinc-700 dark:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800">
          <span class="sr-only">Toggle navigation</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
            <path stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16" />
          </svg>
        </button>
      </div>
      <div id="nav-links" class="mt-2 hidden flex-col gap-1 text-xs font-semibold md:mt-2 md:flex md:flex-row md:flex-wrap md:items-center md:gap-2">
        <a href="/employee/photo-upload/{{ .Token }}" class="block px-2.5 py-1 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-black">Photo Upload</a>
      
      </div>
    </div>
  </nav>


  <section class="card">
    <h1>Upload Your Profile Photo</h1>
    <p class="sub">Employee: <strong>{{ .Employee.TimePunchName }}</strong> (Location {{ .Location.Number }})</p>
    {{ if .Error }}<p class="msg error">{{ .Error }}</p>{{ end }}
    {{ if .SuccessMessage }}<p class="msg ok">{{ .SuccessMessage }}</p>{{ end }}

    <div class="preview-row">
      <div class="preview-box">
        <span class="preview-label">Selected Image</span>
        <div class="crop-stage">
          <img id="preview" class="preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2371717a' font-size='13'%3EPreview%3C/text%3E%3C/svg%3E" alt="Preview">
          <div id="crop_selection" class="crop-selection">
            <div id="crop_handle" class="crop-handle"></div>
          </div>
        </div>
      </div>
      <div id="crop_result_box" class="preview-box crop-result-box">
        <span class="preview-label">Cropped Result</span>
        <canvas id="crop_result" class="preview" width="160" height="160"></canvas>
      </div>
    </div>

    <form method="post" action="/employee/photo-upload/{{ .Token }}" enctype="multipart/form-data">
      <input type="hidden" id="crop_x" name="crop_x" value="0">
      <input type="hidden" id="crop_y" name="crop_y" value="0">
      <input type="hidden" id="crop_size" name="crop_size" value="0">

      <div class="field">
        <label class="label" for="photo_file">Photo File</label>
        <input id="photo_file" type="file" name="photo_file" accept="image/png,image/jpeg,image/webp" required>
      </div>

        <div id="crop_tools" class="crop-tools">
        <p class="sub" style="margin:0;">Drag the crop box. Use the bottom-right handle to resize.</p>
        <div class="button-row">
          <button id="confirm_crop" type="button" class="btn secondary">Confirm Crop</button>
          <button id="upload_btn" type="submit" class="btn" disabled>Upload Photo</button>
          <button id="cancel_upload" type="button" class="btn secondary">Cancel Upload</button>
        </div>
      </div>
    </form>
  </section>

  <script>
    const preview = document.getElementById("preview");
    const fileInput = document.getElementById("photo_file");
    const cropSelection = document.getElementById("crop_selection");
    const cropHandle = document.getElementById("crop_handle");
    const cropX = document.getElementById("crop_x");
    const cropY = document.getElementById("crop_y");
    const cropSize = document.getElementById("crop_size");
    const cropTools = document.getElementById("crop_tools");
    const cropResultBox = document.getElementById("crop_result_box");
    const cropResult = document.getElementById("crop_result");
    const cropCtx = cropResult.getContext("2d");
    const confirmCropBtn = document.getElementById("confirm_crop");
    const uploadBtn = document.getElementById("upload_btn");
    const cancelUploadBtn = document.getElementById("cancel_upload");
    const originalPreviewSrc = preview.getAttribute("src") || "";
    let naturalWidth = 0;
    let naturalHeight = 0;
    let fileSelected = false;
    let cropRect = { x: 0, y: 0, size: 0 };
    let dragMode = "";
    let pointerStart = { x: 0, y: 0 };
    let rectStart = { x: 0, y: 0, size: 0 };
    let cropConfirmed = false;
    let cropLocked = false;

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function drawCropPreview() {
      if (!cropCtx || naturalWidth <= 0 || naturalHeight <= 0) return;
      sync();
      const size = Number(cropSize.value || "0");
      const x = Number(cropX.value || "0");
      const y = Number(cropY.value || "0");
      if (size <= 0) return;
      cropCtx.clearRect(0, 0, cropResult.width, cropResult.height);
      cropCtx.drawImage(preview, x, y, size, size, 0, 0, cropResult.width, cropResult.height);
    }

    function sync() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (displayWidth <= 0 || displayHeight <= 0 || naturalWidth <= 0 || naturalHeight <= 0) return;
      const scaleX = naturalWidth / displayWidth;
      const scaleY = naturalHeight / displayHeight;
      cropX.value = String(Math.round(cropRect.x * scaleX));
      cropY.value = String(Math.round(cropRect.y * scaleY));
      cropSize.value = String(Math.round(cropRect.size * Math.min(scaleX, scaleY)));
    }

    function renderCropSelection() {
      cropSelection.style.left = `${cropRect.x}px`;
      cropSelection.style.top = `${cropRect.y}px`;
      cropSelection.style.width = `${cropRect.size}px`;
      cropSelection.style.height = `${cropRect.size}px`;
    }

    function initializeCropControls() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      const minDim = Math.min(displayWidth, displayHeight);
      const initial = Math.max(48, Math.floor(minDim * 0.72));
      cropRect.size = Math.min(initial, minDim);
      cropRect.x = Math.floor((displayWidth - cropRect.size) / 2);
      cropRect.y = Math.floor((displayHeight - cropRect.size) / 2);
      renderCropSelection();
      drawCropPreview();
    }

    function onPointerMove(event) {
      if (!dragMode || cropLocked) return;
      const dx = event.clientX - pointerStart.x;
      const dy = event.clientY - pointerStart.y;
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (dragMode === "move") {
        cropRect.x = clamp(rectStart.x + dx, 0, displayWidth - rectStart.size);
        cropRect.y = clamp(rectStart.y + dy, 0, displayHeight - rectStart.size);
      } else if (dragMode === "resize") {
        const maxSize = Math.min(displayWidth - rectStart.x, displayHeight - rectStart.y);
        cropRect.size = clamp(rectStart.size + Math.max(dx, dy), 48, maxSize);
      }
      setCropConfirmed(false);
      renderCropSelection();
      drawCropPreview();
      event.preventDefault();
    }

    function onPointerUp() {
      dragMode = "";
      window.removeEventListener("pointermove", onPointerMove);
      window.removeEventListener("pointerup", onPointerUp);
    }
    function setCropModeActive(active) {
      cropTools.classList.toggle("is-active", active);
      cropResultBox.classList.toggle("is-active", active);
      cropSelection.classList.toggle("is-active", active);
      if (!active && cropCtx) {
        cropCtx.clearRect(0, 0, cropResult.width, cropResult.height);
      }
      setCropConfirmed(false);
    }

    function setCropConfirmed(value) {
      cropConfirmed = value;
      cropLocked = value;
      cropSelection.classList.toggle("is-locked", value);
      uploadBtn.disabled = !value;
      confirmCropBtn.textContent = value ? "Crop Confirmed" : "Confirm Crop";
    }

    function cancelUpload() {
      fileSelected = false;
      fileInput.value = "";
      naturalWidth = 0;
      naturalHeight = 0;
      cropX.value = "0";
      cropY.value = "0";
      cropSize.value = "0";
      setCropModeActive(false);
      cropSelection.classList.remove("is-active");
      if (originalPreviewSrc !== "") {
        preview.src = originalPreviewSrc;
      }
      setCropConfirmed(false);
    }

    cropSelection.addEventListener("pointerdown", (event) => {
      if (!fileSelected || cropLocked) return;
      dragMode = event.target === cropHandle ? "resize" : "move";
      pointerStart = { x: event.clientX, y: event.clientY };
      rectStart = { x: cropRect.x, y: cropRect.y, size: cropRect.size };
      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp);
      event.preventDefault();
    });
    fileInput.addEventListener("change", () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        cancelUpload();
        return;
      }
      fileSelected = true;
      setCropModeActive(true);
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    preview.addEventListener("load", () => {
      if (!fileSelected) return;
      naturalWidth = preview.naturalWidth || 0;
      naturalHeight = preview.naturalHeight || 0;
      if (naturalWidth <= 0 || naturalHeight <= 0) return;
      initializeCropControls();
      setCropConfirmed(false);
    });

    confirmCropBtn.addEventListener("click", () => {
      if (!fileSelected) return;
      drawCropPreview();
      setCropConfirmed(true);
    });
    cancelUploadBtn.addEventListener("click", cancelUpload);
    setCropModeActive(false);
  </script>
    <script>
    (function () {
      const storageKey = "cfasuite-theme";
      const root = document.documentElement;
      const toggle = document.getElementById("theme-toggle");
      const navToggle = document.getElementById("nav-toggle");
      const navLinks = document.getElementById("nav-links");

      function currentTheme() {
        return root.classList.contains("dark") ? "dark" : "light";
      }
      function updateThemeA11y() {
        if (!toggle) return;
        const next = currentTheme() === "dark" ? "light" : "dark";
        toggle.setAttribute("aria-label", "Switch to " + next + " mode");
        toggle.title = "Switch to " + next + " mode";
      }
      updateThemeA11y();

      if (toggle) {
        toggle.addEventListener("click", function () {
          const next = currentTheme() === "dark" ? "light" : "dark";
          root.classList.toggle("dark", next === "dark");
          window.localStorage.setItem(storageKey, next);
          updateThemeA11y();
        });
      }

      if (navToggle && navLinks) {
        navToggle.addEventListener("click", function () {
          const expanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", expanded ? "false" : "true");
          navLinks.classList.toggle("hidden", expanded);
        });
      }
    })();
  </script>


</body>
</html>
