<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ .CSRF }}">
  <title>Candidates</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a; --warning: #d97706;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80; --warning: #fbbf24;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background-color: var(--bg); color: var(--fg); font-family: "Manrope", ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2, h3 { margin: 0; font-family: "Space Grotesk", "Manrope", sans-serif; font-weight: 700; line-height: 1.25; }
    h1 { font-size: clamp(1.375rem, 3vw, 1.875rem); }
    h2 { font-size: 1.125rem; }
    p { margin: 0; }
    .text-muted { color: var(--muted-fg); font-size: 0.875rem; }
    .card, .panel { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; box-shadow: var(--shadow); }
    .stack { display: grid; gap: 1rem; }
    .grid-2 { display: grid; gap: 0.75rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { display: grid; gap: 0.75rem; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    input, select, textarea { display: block; width: 100%; min-height: 2.375rem; padding: 0.5rem 0.75rem; font: 0.875rem/1.5 inherit; color: var(--fg); background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; }
    textarea { min-height: 5.5rem; resize: vertical; }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.375rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; min-height: 2.375rem; padding: 0.5rem 0.875rem; font: 600 0.875rem/1.25 inherit; border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; }
    .btn-primary { background-color: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
    .btn-outline { background-color: transparent; color: var(--fg); border-color: var(--border); }
    .btn-danger { background-color: transparent; color: var(--danger); border-color: var(--danger); }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .alert { border-radius: 0.5rem; padding: 0.625rem 0.75rem; font-size: 0.875rem; border: 1px solid var(--border); }
    .alert-success { border-color: color-mix(in srgb, var(--success) 35%, var(--border)); color: var(--success); }
    .alert-error { border-color: color-mix(in srgb, var(--danger) 35%, var(--border)); color: var(--danger); }
    .warning-banner {
      margin: 0.25rem 0 0;
      border: 2px solid var(--danger);
      border-radius: 0.625rem;
      background: color-mix(in srgb, var(--danger) 12%, var(--bg));
      color: var(--danger);
      padding: 0.875rem 1rem;
    }
    .warning-banner strong { display: block; font-size: 1rem; line-height: 1.25; }
    .warning-banner span { display: block; font-size: 0.875rem; margin-top: 0.25rem; color: var(--fg); font-weight: 600; }
    .warning-banner.warn {
      border-color: var(--warning);
      background: color-mix(in srgb, var(--warning) 14%, var(--bg));
      color: var(--warning);
    }
    .back { font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); display: inline-flex; align-items: center; margin-bottom: 1rem; text-decoration: none; }
    .value-item { border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 0.625rem; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
    th { color: var(--muted-fg); font-weight: 600; }
    .active-candidate-list { display: grid; gap: 0.5rem; }
    .active-candidate-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 0.5rem;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 0.625rem;
      padding: 0.75rem 0.875rem;
      background: var(--card);
      color: var(--fg);
      text-decoration: none;
      transition: background-color 120ms, border-color 120ms, transform 120ms;
      cursor: pointer;
    }
    .active-candidate-main { color: inherit; text-decoration: none; display: contents; }
    .active-candidate-row:hover {
      background: color-mix(in srgb, var(--card) 92%, var(--muted));
      border-color: var(--primary);
      text-decoration: none;
      transform: translateY(-1px);
    }
    .active-candidate-name { font-weight: 700; line-height: 1.25; }
    .active-candidate-meta { color: var(--muted-fg); font-size: 0.8125rem; text-align: right; }
    .active-candidate-delete { margin: 0; }
    @media (max-width: 700px) {
      .active-candidate-row { grid-template-columns: 1fr; }
      .active-candidate-meta { text-align: left; }
    }

    .hub { display: grid; gap: 0.75rem; grid-template-columns: 1fr; margin-top: 0.75rem; }
    @media (min-width: 640px) { .hub { grid-template-columns: repeat(4, 1fr); } }
    .hub-btn { width: 100%; text-align: left; padding: 0.875rem 1rem; background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; cursor: pointer; font-family: inherit; color: var(--fg); transition: 150ms; }
    .hub-btn:hover { background-color: var(--muted); }
    .hub-btn.active { background-color: var(--muted); border-color: var(--primary); }
    .hub-btn strong { display: block; font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.25rem; }
    .hub-btn span { display: block; font-size: 0.8125rem; color: var(--muted-fg); }
    .section { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .section.active { display: block; }
    .process-hub { display: grid; gap: 0.625rem; grid-template-columns: 1fr; margin-top: 0.5rem; }
    @media (min-width: 700px) { .process-hub { grid-template-columns: repeat(3, 1fr); } }
    .process-btn {
      width: 100%;
      text-align: left;
      padding: 0.75rem 0.875rem;
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      cursor: pointer;
      font-family: inherit;
      color: var(--fg);
      transition: 150ms;
      font-weight: 700;
      font-size: 0.875rem;
    }
    .process-btn:hover { background-color: var(--muted); }
    .process-btn.active { background-color: var(--muted); border-color: var(--primary); }
    .process-panel { display: none; margin-top: 0.25rem; }
    .process-panel.active { display: block; }
    .link-box { border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; background: color-mix(in srgb, var(--card) 96%, var(--muted)); }
    .copy-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .copy-row input { flex: 1; min-width: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 0.8rem; }
    .calendar-head { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .month-btn { min-height:2.25rem; padding:.4rem .7rem; border:1px solid var(--border); border-radius:.5rem; background:var(--bg); color:var(--fg); cursor:pointer; font-weight:700; }
    .month-label { font-weight:700; font-size:1rem; }
    .weekdays { display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.35rem; color:var(--muted-fg); font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; }
    .weekdays div { text-align:center; padding:.25rem 0; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.35rem; }
    .calendar-day {
      min-height:90px; border:1px solid var(--border); border-radius:.5rem; padding:.4rem;
      background:var(--card); cursor:pointer; display:flex; flex-direction:column; gap:.35rem;
    }
    .calendar-day.empty { cursor:default; background:color-mix(in srgb,var(--card) 98%,var(--muted)); }
    .calendar-day.selected { border-color:var(--primary); }
    .calendar-day-num { font-size:.8rem; font-weight:700; }
    .calendar-day-count { font-size:.72rem; color:var(--muted-fg); }
    .calendar-day-preview { font-size:.72rem; color:var(--fg); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .calendar-day-panel { border:1px solid var(--border); border-radius:.6rem; padding:.75rem; }
    .calendar-day-title { font-size:1rem; margin:0 0 .5rem 0; font-family:"Space Grotesk","Manrope",sans-serif; }
    .calendar-day-list { display:grid; gap:.5rem; }
    .calendar-item { border:1px solid var(--border); border-radius:.5rem; padding:.6rem; display:grid; gap:.3rem; background:var(--card); }
    .calendar-item a { text-decoration:none; color:var(--primary); font-weight:700; }
    .calendar-item-meta { color:var(--muted-fg); font-size:.8rem; }
  </style>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors">
  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
        <a href="/admin/locations/{{ .Location.Number }}/candidates" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Candidates</a>
      </nav>
      <div class="flex items-center gap-2 shrink-0">
        <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
        <button id="theme-toggle" type="button" aria-label="Toggle theme" class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
      </div>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto max-w-[1100px] stack">
      <div class="card stack">
        <a class="back" href="/admin/locations/{{ .Location.Number }}">&#8592; Back to Apps</a>
        <div>
          <h1>Candidates</h1>
          <p class="text-muted" style="margin-top:0.25rem;">{{ .Location.Name }} ({{ .Location.Number }})</p>
        </div>
        {{ if .SuccessMessage }}<div class="alert alert-success">{{ .SuccessMessage }}</div>{{ end }}
        {{ if .Error }}<div class="alert alert-error">{{ .Error }}</div>{{ end }}
        {{ if .HasStaleCandidateInterviews }}
          <div class="warning-banner" role="alert">
            <strong>Warning: Stale interviews exist.</strong>
            <span>{{ .StaleCandidateInterviewCount }} scheduled interview{{ if ne .StaleCandidateInterviewCount 1 }}s{{ end }} are over 4 hours old and still incomplete. Complete or delete them.</span>
          </div>
        {{ else if .HasActiveCandidates }}
          <div class="warning-banner warn" role="status">
            <strong>Reminder: You have active candidates pending decisions.</strong>
            <span>{{ .ActiveCandidateCount }} candidate{{ if ne .ActiveCandidateCount 1 }}s{{ end }} are still in progress.</span>
          </div>
        {{ end }}

        <div class="hub">
          <button class="hub-btn" type="button" data-target="interviews">
            <strong>Active Candidates</strong>
            <span>Open and manage active candidate records.</span>
          </button>
          <button class="hub-btn" type="button" data-target="new-candidate">
            <strong>New Candidate</strong>
            <span>Create candidate profiles quickly.</span>
          </button>
          <button class="hub-btn" type="button" data-target="archive">
            <strong>Archive</strong>
            <span>Search passed and hired candidates.</span>
          </button>
          <button class="hub-btn" type="button" data-target="calendar">
            <strong>Interview Calendar</strong>
            <span>View and open scheduled interviews by month.</span>
          </button>
        </div>

        <section class="section" data-panel="new-candidate">
          <div class="panel stack">
            <div>
              <h2>New Candidate</h2>
              <p class="text-muted" style="margin-top:0.25rem;">Create with first name, last name, and phone number.</p>
            </div>
            <form method="post" action="/admin/locations/{{ .Location.Number }}/candidates" class="stack">
              <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
              <div class="grid-2">
                <div>
                  <label for="first_name">First Name</label>
                  <input id="first_name" name="first_name" type="text" maxlength="80" required>
                </div>
                <div>
                  <label for="last_name">Last Name</label>
                  <input id="last_name" name="last_name" type="text" maxlength="80" required>
                </div>
                <div>
                  <label for="phone">Phone Number</label>
                  <div style="display:inline-grid;grid-template-columns:96px auto 96px auto 96px;gap:8px;align-items:center;justify-content:start;">
                    <input id="phone_1" name="phone_1" type="text" inputmode="numeric" maxlength="3" pattern="[0-9]{3}" placeholder="615" autocomplete="tel-area-code" required>
                    <span style="font-weight:700;color:var(--muted-fg);text-align:center;">-</span>
                    <input id="phone_2" name="phone_2" type="text" inputmode="numeric" maxlength="3" pattern="[0-9]{3}" placeholder="555" autocomplete="tel-local-prefix" required>
                    <span style="font-weight:700;color:var(--muted-fg);text-align:center;">-</span>
                    <input id="phone_3" name="phone_3" type="text" inputmode="numeric" maxlength="4" pattern="[0-9]{4}" placeholder="1234" autocomplete="tel-local-suffix" required>
                  </div>
                </div>
              </div>
              <div><button class="btn btn-primary" type="submit">Create Candidate</button></div>
            </form>
          </div>
        </section>

        <section class="section" data-panel="interviews">
          <div class="stack">
            <div>
              <h2>Active Candidates</h2>
              <p class="text-muted" style="margin-top:0.25rem;">Search and click a row to open candidate details.</p>
            </div>
            <div>
              <input id="active-candidate-search" type="text" placeholder="Search active candidates by name">
            </div>
            {{ if .Candidates }}
              <div id="active-candidate-list" class="active-candidate-list">
                {{ range .Candidates }}
                  <div class="active-candidate-row" data-search-name="{{ .FirstName }} {{ .LastName }}">
                    <a class="active-candidate-main" href="/admin/locations/{{ $.Location.Number }}/candidates/{{ .ID }}">
                      <span class="active-candidate-name">{{ .FirstName }} {{ .LastName }}</span>
                      <span class="active-candidate-meta">{{ .Phone }} · Created {{ .CreatedAt }}</span>
                    </a>
                  </div>
                {{ end }}
              </div>
            {{ else }}
              <p class="text-muted">No active candidates.</p>
            {{ end }}
          </div>
        </section>

        <section class="section" data-panel="archive">
          <div class="stack">
            <div>
              <h2>Archive</h2>
              <p class="text-muted" style="margin-top:0.25rem;">Search passed or hired candidates.</p>
            </div>
            <form method="get" action="/admin/locations/{{ .Location.Number }}/candidates" class="row">
              <input type="text" name="archive_search" value="{{ .Search }}" placeholder="Search by first or last name" style="max-width:320px;">
              <button class="btn btn-outline" type="submit">Search</button>
            </form>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Hired Employee</th>
                    <th>Archived At</th>
                    <th>Scorecard</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
                  {{ if .ArchivedCandidates }}
                    {{ range .ArchivedCandidates }}
                      <tr>
                        <td>{{ .FirstName }} {{ .LastName }}</td>
                        <td>{{ .Phone }}</td>
                        <td>{{ .Status }}</td>
                        <td>{{ if .HiredTimePunchName }}<a href="/admin/locations/{{ $.Location.Number }}/employees/{{ .HiredTimePunchName }}">{{ .HiredTimePunchName }}</a>{{ else }}-{{ end }}</td>
                        <td>{{ if .ArchivedAt }}{{ .ArchivedAt }}{{ else }}-{{ end }}</td>
                        <td><a class="btn btn-outline" href="/admin/locations/{{ $.Location.Number }}/candidates/{{ .ID }}/scorecard">View</a></td>
                        <td>
                          <form method="post" action="/admin/locations/{{ $.Location.Number }}/candidates/{{ .ID }}/delete">
                            <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                            <button class="btn btn-danger" type="submit" onclick="return confirm('Delete this candidate? This will remove linked interview sessions and cannot be undone.');">Delete</button>
                          </form>
                        </td>
                      </tr>
                    {{ end }}
                  {{ else }}
                    <tr>
                      <td colspan="7" class="text-muted">No archived candidates.</td>
                    </tr>
                  {{ end }}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="section" data-panel="calendar">
          <div class="stack">
            <div>
              <h2>Interview Calendar</h2>
              <p class="text-muted" style="margin-top:0.25rem;">All scheduled interviews. Click a day to open interview sessions quickly.</p>
            </div>
            <div class="calendar-head">
              <button id="calendar-prev-month" class="month-btn" type="button">Previous</button>
              <div id="calendar-month-label" class="month-label"></div>
              <button id="calendar-next-month" class="month-btn" type="button">Next</button>
            </div>
            <div class="weekdays">
              <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="calendar-grid"></div>
            <section id="calendar-day-panel" class="calendar-day-panel">
              <h3 id="calendar-day-title" class="calendar-day-title"></h3>
              <div id="calendar-day-list" class="calendar-day-list"></div>
            </section>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var storageKey = "cfasuite-theme";
      var root = document.documentElement;
      var toggle = document.getElementById("theme-toggle");
      if (toggle) {
        toggle.addEventListener("click", function () {
          var isDark = root.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
        });
      }

      var interviewCalendar = [
        {{- range .InterviewCalendar }}
        {
          token: "{{ .Token }}",
          candidateId: Number("{{ .CandidateID }}"),
          candidateFirstName: "{{ .CandidateFirstName }}",
          candidateLastName: "{{ .CandidateLastName }}",
          interviewerTimePunchName: "{{ .InterviewerTimePunchName }}",
          interviewType: "{{ .InterviewType }}",
          scheduledAt: "{{ .ScheduledAt }}",
          usedAt: "{{ .UsedAt }}"
        },
        {{- end }}
      ];

      var hubButtons = Array.from(document.querySelectorAll(".hub-btn"));
      var panels = Array.from(document.querySelectorAll(".section[data-panel]"));

      function showPanel(name) {
        hubButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.getAttribute("data-target") === name);
        });
        panels.forEach(function (panel) {
          panel.classList.toggle("active", panel.getAttribute("data-panel") === name);
        });
        if (window.location.hash !== "#" + name) {
          window.history.replaceState(null, "", "#" + name);
        }
      }

      hubButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          showPanel(btn.getAttribute("data-target"));
        });
      });

      var initial = window.location.hash ? window.location.hash.slice(1) : "interviews";
      var exists = panels.some(function (panel) { return panel.getAttribute("data-panel") === initial; });
      showPanel(exists ? initial : "interviews");
      var activeSearchInput = document.getElementById("active-candidate-search");
      var activeRows = Array.from(document.querySelectorAll(".active-candidate-row"));
      if (activeSearchInput && activeRows.length > 0) {
        activeSearchInput.addEventListener("input", function () {
          var query = (activeSearchInput.value || "").toLowerCase().trim();
          activeRows.forEach(function (row) {
            var name = (row.getAttribute("data-search-name") || "").toLowerCase();
            row.style.display = !query || name.indexOf(query) >= 0 ? "" : "none";
          });
        });
      }

      function digitsOnly(value, maxLen) {
        return (value || "").replace(/\D+/g, "").slice(0, maxLen);
      }

      var phone1 = document.getElementById("phone_1");
      var phone2 = document.getElementById("phone_2");
      var phone3 = document.getElementById("phone_3");
      if (phone1 && phone2 && phone3) {
        phone1.addEventListener("input", function () {
          phone1.value = digitsOnly(phone1.value, 3);
          if (phone1.value.length === 3) phone2.focus();
        });
        phone2.addEventListener("input", function () {
          phone2.value = digitsOnly(phone2.value, 3);
          if (phone2.value.length === 3) phone3.focus();
        });
        phone3.addEventListener("input", function () {
          phone3.value = digitsOnly(phone3.value, 4);
        });
      }

      var calendarMonthLabel = document.getElementById("calendar-month-label");
      var calendarGrid = document.getElementById("calendar-grid");
      var calendarPrevMonth = document.getElementById("calendar-prev-month");
      var calendarNextMonth = document.getElementById("calendar-next-month");
      var calendarDayPanel = document.getElementById("calendar-day-panel");
      var calendarDayTitle = document.getElementById("calendar-day-title");
      var calendarDayList = document.getElementById("calendar-day-list");

      function parseScheduled(value) {
        if (!value) return null;
        var parsed = new Date(value);
        if (!isNaN(parsed.getTime())) return parsed;
        return null;
      }

      var calendarItems = interviewCalendar.map(function (entry) {
        return {
          token: entry.token,
          candidateId: entry.candidateId,
          candidateName: [entry.candidateFirstName, entry.candidateLastName].join(" ").trim(),
          interviewer: entry.interviewerTimePunchName,
          interviewType: entry.interviewType,
          scheduledAt: parseScheduled(entry.scheduledAt),
          usedAt: parseScheduled(entry.usedAt)
        };
      }).filter(function (entry) {
        return entry.scheduledAt instanceof Date;
      });

      var calendarByDate = new Map();
      calendarItems.forEach(function (entry) {
        var key = [
          entry.scheduledAt.getFullYear(),
          String(entry.scheduledAt.getMonth() + 1).padStart(2, "0"),
          String(entry.scheduledAt.getDate()).padStart(2, "0")
        ].join("-");
        if (!calendarByDate.has(key)) calendarByDate.set(key, []);
        calendarByDate.get(key).push(entry);
      });
      calendarByDate.forEach(function (entries, key) {
        entries.sort(function (a, b) {
          return a.scheduledAt.getTime() - b.scheduledAt.getTime();
        });
        calendarByDate.set(key, entries);
      });

      var now = new Date();
      var currentCalendarYear = now.getFullYear();
      var currentCalendarMonth = now.getMonth();
      var selectedCalendarDate = "";

      function formatDateKey(year, monthIndex, day) {
        return year + "-" + String(monthIndex + 1).padStart(2, "0") + "-" + String(day).padStart(2, "0");
      }

      function renderCalendarDayList(dateKey) {
        if (!calendarDayPanel || !calendarDayTitle || !calendarDayList) return;
        var entries = calendarByDate.get(dateKey) || [];
        var parsed = new Date(dateKey + "T00:00:00");
        calendarDayTitle.textContent = parsed.toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric", year: "numeric" });
        if (entries.length === 0) {
          calendarDayList.innerHTML = '<p class="text-muted">No interviews scheduled for this day.</p>';
          return;
        }
        var html = entries.map(function (entry) {
          var timeLabel = entry.scheduledAt.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
          var detailPath = "/interview/" + encodeURIComponent(entry.token);
          var statusLabel = entry.usedAt ? "Completed" : "Scheduled";
          return '' +
            '<article class="calendar-item">' +
              '<a href="' + detailPath + '">' + timeLabel + " · " + entry.candidateName + '</a>' +
              '<div class="calendar-item-meta">' + entry.interviewType + ' · Interviewer: ' + entry.interviewer + '</div>' +
              '<div class="calendar-item-meta">' + statusLabel + '</div>' +
            '</article>';
        }).join("");
        calendarDayList.innerHTML = html;
      }

      function renderCalendarGrid() {
        if (!calendarGrid || !calendarMonthLabel) return;
        var firstOfMonth = new Date(currentCalendarYear, currentCalendarMonth, 1);
        var startDay = firstOfMonth.getDay();
        var daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        calendarMonthLabel.textContent = firstOfMonth.toLocaleDateString(undefined, { month: "long", year: "numeric" });

        var cells = [];
        for (var blank = 0; blank < startDay; blank++) {
          cells.push('<div class="calendar-day empty"></div>');
        }
        for (var day = 1; day <= daysInMonth; day++) {
          var key = formatDateKey(currentCalendarYear, currentCalendarMonth, day);
          var entries = calendarByDate.get(key) || [];
          var preview = entries.slice(0, 2).map(function (entry) {
            return '<div class="calendar-day-preview">' + entry.candidateName + '</div>';
          }).join("");
          if (entries.length > 2) {
            preview += '<div class="calendar-day-preview">+' + (entries.length - 2) + ' more</div>';
          }
          cells.push(
            '<button type="button" class="calendar-day' + (selectedCalendarDate === key ? ' selected' : '') + '" data-calendar-date="' + key + '">' +
              '<div class="calendar-day-num">' + day + '</div>' +
              '<div class="calendar-day-count">' + entries.length + (entries.length === 1 ? ' interview' : ' interviews') + '</div>' +
              preview +
            '</button>'
          );
        }
        calendarGrid.innerHTML = cells.join("");
        Array.from(calendarGrid.querySelectorAll("[data-calendar-date]")).forEach(function (button) {
          button.addEventListener("click", function () {
            selectedCalendarDate = button.getAttribute("data-calendar-date") || "";
            renderCalendarGrid();
            renderCalendarDayList(selectedCalendarDate);
          });
        });
      }

      if (calendarPrevMonth && calendarNextMonth && calendarGrid) {
        calendarPrevMonth.addEventListener("click", function () {
          currentCalendarMonth -= 1;
          if (currentCalendarMonth < 0) {
            currentCalendarMonth = 11;
            currentCalendarYear -= 1;
          }
          renderCalendarGrid();
        });
        calendarNextMonth.addEventListener("click", function () {
          currentCalendarMonth += 1;
          if (currentCalendarMonth > 11) {
            currentCalendarMonth = 0;
            currentCalendarYear += 1;
          }
          renderCalendarGrid();
        });

        if (calendarItems.length > 0) {
          currentCalendarYear = calendarItems[0].scheduledAt.getFullYear();
          currentCalendarMonth = calendarItems[0].scheduledAt.getMonth();
          selectedCalendarDate = formatDateKey(currentCalendarYear, currentCalendarMonth, calendarItems[0].scheduledAt.getDate());
        } else {
          selectedCalendarDate = formatDateKey(currentCalendarYear, currentCalendarMonth, now.getDate());
        }
        renderCalendarGrid();
        renderCalendarDayList(selectedCalendarDate);
      }

    })();
  </script>
</body>
</html>
