<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interview Process</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background-color: var(--bg); color: var(--fg); font-family: "Manrope", ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2 { margin: 0; font-family: "Space Grotesk", "Manrope", sans-serif; font-weight: 700; line-height: 1.25; }
    h1 { font-size: clamp(1.375rem, 3vw, 1.875rem); }
    h2 { font-size: 1.125rem; }
    p { margin: 0; }
    .text-muted { color: var(--muted-fg); font-size: 0.875rem; }
    .card, .panel { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; box-shadow: var(--shadow); }
    .stack { display: grid; gap: 1rem; }
    .grid-3 { display: grid; gap: 0.75rem; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }
    input, textarea { display: block; width: 100%; min-height: 2.375rem; padding: 0.5rem 0.75rem; font: 0.875rem/1.5 inherit; color: var(--fg); background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; }
    textarea { min-height: 5.5rem; resize: vertical; }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.375rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; min-height: 2.375rem; padding: 0.5rem 0.875rem; font: 600 0.875rem/1.25 inherit; border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; }
    .btn-primary { background-color: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
    .btn-outline { background-color: transparent; color: var(--fg); border-color: var(--border); }
    .btn-danger { background-color: transparent; color: var(--danger); border-color: var(--danger); }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .alert { border-radius: 0.5rem; padding: 0.625rem 0.75rem; font-size: 0.875rem; border: 1px solid var(--border); }
    .alert-success { border-color: color-mix(in srgb, var(--success) 35%, var(--border)); color: var(--success); }
    .alert-error { border-color: color-mix(in srgb, var(--danger) 35%, var(--border)); color: var(--danger); }
    .back { font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); display: inline-flex; align-items: center; margin-bottom: 1rem; text-decoration: none; }
    .value-item { border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; }
    .process-hub { display: grid; gap: 0.625rem; grid-template-columns: 1fr; margin-top: 0.5rem; }
    @media (min-width: 700px) { .process-hub { grid-template-columns: repeat(3, 1fr); } }
    .process-btn { width: 100%; text-align: left; padding: 0.75rem 0.875rem; background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; cursor: pointer; font-family: inherit; color: var(--fg); transition: 150ms; font-weight: 700; font-size: 0.875rem; }
    .process-btn:hover { background-color: var(--muted); }
    .process-btn.active { background-color: var(--muted); border-color: var(--primary); }
    .process-panel { display: none; margin-top: 0.25rem; }
    .process-panel.active { display: block; }
    .sub-hub { display:grid; gap:.5rem; grid-template-columns:1fr; margin:.25rem 0 .5rem; }
    @media (min-width: 700px) { .sub-hub { grid-template-columns:repeat(2,1fr); } }
    .sub-btn { width:100%; text-align:left; padding:.625rem .75rem; background:var(--bg); border:1px solid var(--border); border-radius:.5rem; cursor:pointer; font-family:inherit; color:var(--fg); transition:150ms; font-weight:700; font-size:.8125rem; }
    .sub-btn:hover { background:var(--muted); }
    .sub-btn.active { background:var(--muted); border-color:var(--primary); }
    .sub-panel { display:none; }
    .sub-panel.active { display:block; }
    .question-list { display: grid; gap: 0.625rem; }
    .question-item { border: 1px solid var(--border); border-radius: 0.5rem; background: var(--card); overflow: hidden; }
    .question-summary { list-style: none; cursor: pointer; padding: 0.75rem 0.875rem; display: grid; gap: 0.5rem; }
    .question-summary::-webkit-details-marker { display: none; }
    .question-summary:hover { background: color-mix(in srgb, var(--card) 92%, var(--muted)); }
    .question-title { font-weight: 700; line-height: 1.35; }
    .question-tags { display: flex; flex-wrap: wrap; gap: 0.375rem; }
    .question-tag { border: 1px solid var(--border); border-radius: 999px; padding: 0.1rem 0.5rem; font-size: 0.75rem; color: var(--muted-fg); }
    .question-body { border-top: 1px solid var(--border); padding: 0.875rem; display: grid; gap: 0.75rem; }
    .question-item[open] .question-summary { background: color-mix(in srgb, var(--card) 90%, var(--muted)); }
    .response-option-row { display: grid; grid-template-columns: minmax(0, 1fr) auto; gap: 0.5rem; align-items: center; }
    .response-option-remove-btn { width: auto; white-space: nowrap; min-height: 2.35rem; }
    .response-options-actions { margin-top: 0.375rem; }
    .name-order-row { display: flex; flex-wrap: nowrap; gap: 0.625rem; align-items: stretch; overflow-x: auto; padding-bottom: 0.25rem; }
    .name-order-card {
      min-width: 220px;
      max-width: 320px;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.625rem;
      background: var(--card);
      cursor: grab;
      display: grid;
      gap: 0.5rem;
    }
    .name-order-card.dragging { opacity: 0.55; }
    .name-order-card-title { font-weight: 700; }
    .order-status { min-height: 1.25rem; font-size: 0.8125rem; color: var(--muted-fg); }
    .order-status.error { color: var(--danger); }
    .order-status.success { color: var(--success); }
  </style>
</head>
<body>
  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
        <a href="/admin/locations/{{ .Location.Number }}/candidates" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Candidates</a>
        <a href="/admin/locations/{{ .Location.Number }}/interview-process" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Interview Process</a>
      </nav>
      <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto max-w-[1100px] stack">
      <div class="card stack">
        <a class="back" href="/admin/locations/{{ .Location.Number }}">&#8592; Back to Apps</a>
        <div>
          <h1>Interview Process</h1>
          <p class="text-muted" style="margin-top:0.25rem;">{{ .Location.Name }} ({{ .Location.Number }})</p>
        </div>
        {{ if .SuccessMessage }}<div class="alert alert-success">{{ .SuccessMessage }}</div>{{ end }}
        {{ if .Error }}<div class="alert alert-error">{{ .Error }}</div>{{ end }}

        <div class="process-hub">
          <button class="process-btn" type="button" data-process-target="values">Values</button>
          <button class="process-btn" type="button" data-process-target="questions">Questions</button>
          <button class="process-btn" type="button" data-process-target="names">Interview Types</button>
        </div>

        <section class="process-panel" data-process-panel="values">
          <div class="stack">
            <div>
              <h2 style="font-size:1rem;">Values</h2>
              <p class="text-muted" style="margin-top:0.25rem;">High-level cultural values your organization cares about (teamwork, generosity, valuing others).</p>
            </div>
            <form method="post" action="/admin/locations/{{ .Location.Number }}/candidate-values" class="stack">
              <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
              <div>
                <label for="value_name">Value Name</label>
                <input id="value_name" name="name" type="text" maxlength="80" required>
              </div>
              <div>
                <label for="value_description">Description</label>
                <textarea id="value_description" name="description" maxlength="400" placeholder="What does this value mean for this location?"></textarea>
              </div>
              <div><button class="btn btn-primary" type="submit">Add Value</button></div>
            </form>
            <div class="stack">
              {{ if .CandidateValues }}
                {{ range .CandidateValues }}
                  <div class="value-item stack">
                    <div class="row" style="justify-content:space-between;">
                      <strong>{{ .Name }}</strong>
                      <form method="post" action="/admin/locations/{{ $.Location.Number }}/candidate-values/{{ .ID }}/delete">
                        <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                        <button class="btn btn-danger" type="submit">Delete</button>
                      </form>
                    </div>
                    {{ if .Description }}<p class="text-muted">{{ .Description }}</p>{{ end }}
                  </div>
                {{ end }}
              {{ else }}
                <p class="text-muted">No values yet. Add at least one value before interviews.</p>
              {{ end }}
            </div>
          </div>
        </section>

        <section class="process-panel" data-process-panel="questions">
          <div class="stack">
            <div>
              <h2 style="font-size:1rem;">Questions</h2>
              <p class="text-muted" style="margin-top:.25rem;">Use Quick Add to assign many questions to selected interview types in one step, or create a custom question below.</p>
            </div>
            <div class="sub-hub">
              <button class="sub-btn" type="button" data-question-target="create">Create Question</button>
              <button class="sub-btn" type="button" data-question-target="starter">Quick Add</button>
              <button class="sub-btn" type="button" data-question-target="view">View Questions</button>
            </div>
            <section class="sub-panel" data-question-panel="create">
              <form method="post" action="/admin/locations/{{ .Location.Number }}/candidate-interview-questions" class="stack">
                <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                <div>
                  <label for="question_text">Question</label>
                  <input id="question_text" name="question" type="text" maxlength="500" placeholder="Example: Tell me about a time you served a teammate." required>
                </div>
                <div>
                  <label for="response_type_new">Expected Response Type</label>
                  <select id="response_type_new" name="response_type">
                    <option value="text" selected>Text</option>
                    <option value="yes_no">Yes / No</option>
                    <option value="true_false">True / False</option>
                    <option value="multiple_choice">Multiple Choice</option>
                    <option value="number">Number</option>
                  </select>
                </div>
                <div class="response-options-field" style="display:none;">
                  <label>Multiple Choice Options</label>
                  <div class="stack response-options-list"></div>
                  <div class="row response-options-actions">
                    <button class="btn btn-outline add-response-option-btn" type="button">+ Add Option</button>
                  </div>
                  <p class="text-muted">Add at least 2 unique options.</p>
                </div>
                <div class="stack" style="gap:.5rem;">
                  <label>Assign Interview Types</label>
                  <div class="grid-3">
                    {{ range .InterviewNames }}
                      <label class="row" style="justify-content:flex-start;border:1px solid var(--border);border-radius:.5rem;padding:.5rem .625rem;">
                        <input type="checkbox" name="interview_name_ids" value="{{ .ID }}" style="width:auto;min-height:auto;">
                        <span>{{ .Name }}</span>
                      </label>
                    {{ end }}
                  </div>
                  {{ if not .InterviewNames }}<p class="text-muted">Create interview types first, then assign them to questions.</p>{{ end }}
                </div>
                <div><button class="btn btn-primary" type="submit">Add Question</button></div>
              </form>
            </section>
            <section class="sub-panel" data-question-panel="starter">
              <div class="stack">
                <div>
                  <h2 style="font-size:1rem;">Quick Add Questions</h2>
                  <p class="text-muted" style="margin-top:.25rem;">Step 1: select interview types. Step 2: select questions. Step 3: add all at once.</p>
                </div>
                <form method="post" action="/admin/locations/{{ .Location.Number }}/candidate-interview-questions/starters" class="stack">
                  <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                  <div class="stack" style="gap:.5rem;">
                    <div class="row" style="justify-content:space-between;">
                      <label style="margin:0;">Interview Types</label>
                      <div class="row">
                        <button class="btn btn-outline" type="button" data-check-toggle="all" data-check-group="quick-add-types">Select All</button>
                        <button class="btn btn-outline" type="button" data-check-toggle="none" data-check-group="quick-add-types">Clear</button>
                      </div>
                    </div>
                    <div class="grid-3">
                      {{ range .InterviewNames }}
                        <label class="row" style="justify-content:flex-start;border:1px solid var(--border);border-radius:.5rem;padding:.5rem .625rem;">
                          <input type="checkbox" name="interview_name_ids" value="{{ .ID }}" data-check-group-input="quick-add-types" style="width:auto;min-height:auto;">
                          <span>{{ .Name }}</span>
                        </label>
                      {{ end }}
                    </div>
                    {{ if not .InterviewNames }}<p class="text-muted">Create interview types first.</p>{{ end }}
                  </div>
                  <div class="stack" style="gap:.5rem;">
                    <div class="row" style="justify-content:space-between;">
                      <label style="margin:0;">Questions</label>
                      <div class="row">
                        <button class="btn btn-outline" type="button" data-check-toggle="all" data-check-group="quick-add-questions">Select All</button>
                        <button class="btn btn-outline" type="button" data-check-toggle="none" data-check-group="quick-add-questions">Clear</button>
                      </div>
                    </div>
                    <div class="stack" style="gap:.5rem;">
                      {{ range .InterviewQuestionStarters }}
                        <label class="row" style="justify-content:flex-start;align-items:flex-start;border:1px solid var(--border);border-radius:.5rem;padding:.55rem .65rem;">
                          <input type="checkbox" name="starter_key" value="{{ .Key }}" data-check-group-input="quick-add-questions" style="width:auto;min-height:auto;margin-top:.1rem;">
                          <span>
                            <strong style="display:block;line-height:1.35;">{{ .Question }}</strong>
                            <span class="text-muted">{{ .ResponseLabel }}</span>
                          </span>
                        </label>
                      {{ end }}
                    </div>
                  </div>
                  <div>
                    <button class="btn btn-primary" type="submit">Add Selected Questions</button>
                  </div>
                </form>
              </div>
            </section>
            <section class="sub-panel" data-question-panel="view">
              <div class="stack">
                {{ if .InterviewQuestions }}
                  <div class="question-list">
                    {{ range .InterviewQuestions }}
                      <details class="question-item">
                        <summary class="question-summary">
                          <div class="question-title">{{ .Question }}</div>
                          <div class="question-tags">
                            <span class="question-tag">
                              {{ if eq .ResponseKind "yes_no" }}Yes / No{{ else if eq .ResponseKind "true_false" }}True / False{{ else if eq .ResponseType "multiple_choice" }}Multiple Choice{{ else if eq .ResponseType "number" }}Number{{ else }}Text{{ end }}
                            </span>
                            {{ if .InterviewNames }}
                              {{ range .InterviewNames }}
                                <span class="question-tag">{{ . }}</span>
                              {{ end }}
                            {{ else }}
                              <span class="question-tag">Unassigned Interview Types</span>
                            {{ end }}
                          </div>
                        </summary>
                        <div class="question-body">
                          <form method="post" action="/admin/locations/{{ $.Location.Number }}/candidate-interview-questions/{{ .ID }}/assign" class="stack question-assign-form" data-selected-ids="{{ range $i, $id := .InterviewNameIDs }}{{ if $i }},{{ end }}{{ $id }}{{ end }}">
                            <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                            <div>
                              <label for="question_{{ .ID }}">Question Text</label>
                              <textarea id="question_{{ .ID }}" name="question" maxlength="500" required>{{ .Question }}</textarea>
                            </div>
                            <div>
                              <label for="response_type_{{ .ID }}">Expected Response Type</label>
                              <select id="response_type_{{ .ID }}" name="response_type">
                                <option value="text" {{ if eq .ResponseKind "text" }}selected{{ end }}>Text</option>
                                <option value="yes_no" {{ if eq .ResponseKind "yes_no" }}selected{{ end }}>Yes / No</option>
                                <option value="true_false" {{ if eq .ResponseKind "true_false" }}selected{{ end }}>True / False</option>
                                <option value="multiple_choice" {{ if eq .ResponseKind "multiple_choice" }}selected{{ end }}>Multiple Choice</option>
                                <option value="number" {{ if eq .ResponseKind "number" }}selected{{ end }}>Number</option>
                              </select>
                            </div>
                            <div class="response-options-field">
                              <label>Multiple Choice Options</label>
                              <div class="stack response-options-list">
                                {{ range .ResponseOptions }}
                                  <div class="response-option-row">
                                    <input type="text" name="response_options" maxlength="200" value="{{ . }}" placeholder="Option value" required>
                                    <button class="btn btn-danger remove-response-option-btn response-option-remove-btn" type="button">Remove</button>
                                  </div>
                                {{ end }}
                              </div>
                              <div class="row response-options-actions">
                                <button class="btn btn-outline add-response-option-btn" type="button">+ Add Option</button>
                              </div>
                              <p class="text-muted">Options must be unique.</p>
                            </div>
                            <div>
                              <label>Interview Types</label>
                              <div class="grid-3">
                                {{ range $.InterviewNames }}
                                  <label class="row" style="justify-content:flex-start;border:1px solid var(--border);border-radius:.5rem;padding:.5rem .625rem;">
                                    <input type="checkbox" name="interview_name_ids" value="{{ .ID }}" style="width:auto;min-height:auto;">
                                    <span>{{ .Name }}</span>
                                  </label>
                                {{ end }}
                              </div>
                            </div>
                            <div class="row">
                              <button class="btn btn-primary" type="submit">Save Changes</button>
                            </div>
                          </form>
                          <form method="post" action="/admin/locations/{{ $.Location.Number }}/candidate-interview-questions/{{ .ID }}/delete">
                            <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                            <button class="btn btn-danger" type="submit">Delete Question</button>
                          </form>
                        </div>
                      </details>
                    {{ end }}
                  </div>
                {{ else }}
                  <p class="text-muted">No interview questions configured yet.</p>
                {{ end }}
              </div>
            </section>
          </div>
        </section>

        <section class="process-panel" data-process-panel="names">
          <div class="stack">
            <div>
              <h2 style="font-size:1rem;">Interview Types</h2>
              <p class="text-muted" style="margin-top:.25rem;">Names of interview types (onboarding, phone interview, face-to-face).</p>
            </div>
            <form method="post" action="/admin/locations/{{ .Location.Number }}/candidate-interview-names" class="row">
              <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
              <input type="text" name="name" maxlength="80" placeholder="Example: Onboarding Interview" required style="max-width:320px;">
              <button class="btn btn-primary" type="submit">Add Type</button>
            </form>
            <div class="stack">
              {{ if .InterviewNames }}
                <p class="text-muted">Drag interview types left-to-right to set priority order. Leftmost is highest priority.</p>
                <div class="name-order-row" id="interview-name-order" data-location-number="{{ .Location.Number }}" data-csrf="{{ .CSRF }}">
                  {{ range .InterviewNames }}
                    <article class="name-order-card" draggable="true" data-name-id="{{ .ID }}">
                      <div class="name-order-card-title">{{ .Name }}</div>
                      <div class="row" style="justify-content:space-between;">
                        <span class="text-muted">Drag to reorder</span>
                        <form method="post" action="/admin/locations/{{ $.Location.Number }}/candidate-interview-names/{{ .ID }}/delete">
                          <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                          <button class="btn btn-danger" type="submit">Delete</button>
                        </form>
                      </div>
                    </article>
                  {{ end }}
                </div>
                <p id="interview-name-order-status" class="order-status"></p>
              {{ else }}
                <p class="text-muted">No interview types configured yet.</p>
              {{ end }}
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var processButtons = Array.from(document.querySelectorAll(".process-btn"));
      var processPanels = Array.from(document.querySelectorAll(".process-panel[data-process-panel]"));
      function showProcessPanel(name) {
        processButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.getAttribute("data-process-target") === name);
        });
        processPanels.forEach(function (panel) {
          panel.classList.toggle("active", panel.getAttribute("data-process-panel") === name);
        });
      }
      processButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-process-target");
          showProcessPanel(target);
          var url = new URL(window.location.href);
          url.searchParams.set("process", target);
          window.history.replaceState(null, "", url.toString());
        });
      });
      var urlParams = new URLSearchParams(window.location.search || "");
      var initialProcess = (urlParams.get("process") || "").toLowerCase().trim();
      var validProcess = ["values", "questions", "names"];
      if (validProcess.indexOf(initialProcess) === -1) {
        initialProcess = "values";
      }
      showProcessPanel(initialProcess);

      var questionButtons = Array.from(document.querySelectorAll(".sub-btn[data-question-target]"));
      var questionPanels = Array.from(document.querySelectorAll(".sub-panel[data-question-panel]"));
      function showQuestionPanel(name) {
        questionButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.getAttribute("data-question-target") === name);
        });
        questionPanels.forEach(function (panel) {
          panel.classList.toggle("active", panel.getAttribute("data-question-panel") === name);
        });
      }
      questionButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var target = (btn.getAttribute("data-question-target") || "").trim();
          if (!target) return;
          showQuestionPanel(target);
          var url = new URL(window.location.href);
          url.searchParams.set("question_panel", target);
          window.history.replaceState(null, "", url.toString());
        });
      });
      var initialQuestionPanel = (urlParams.get("question_panel") || "").toLowerCase().trim();
      var validQuestionPanels = ["create", "starter", "view"];
      if (validQuestionPanels.indexOf(initialQuestionPanel) === -1) {
        initialQuestionPanel = "create";
      }
      showQuestionPanel(initialQuestionPanel);

      var questionAssignForms = Array.from(document.querySelectorAll(".question-assign-form"));
      questionAssignForms.forEach(function (form) {
        var raw = (form.getAttribute("data-selected-ids") || "").trim();
        if (!raw) return;
        var selected = {};
        raw.split(",").forEach(function (entry) {
          var id = (entry || "").trim();
          if (id) selected[id] = true;
        });
        Array.from(form.querySelectorAll('input[name="interview_name_ids"]')).forEach(function (checkbox) {
          checkbox.checked = !!selected[(checkbox.value || "").trim()];
        });
      });

      function buildResponseOptionRow(value) {
        var row = document.createElement("div");
        row.className = "response-option-row";

        var input = document.createElement("input");
        input.type = "text";
        input.name = "response_options";
        input.maxLength = 200;
        input.placeholder = "Option value";
        input.required = true;
        input.value = value || "";

        var removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn btn-danger remove-response-option-btn response-option-remove-btn";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", function () {
          row.remove();
        });

        row.appendChild(input);
        row.appendChild(removeBtn);
        return row;
      }

      function ensureMinimumOptionRows(form, minRows) {
        var optionsList = form.querySelector(".response-options-list");
        if (!optionsList) return;
        while (optionsList.querySelectorAll('input[name="response_options"]').length < minRows) {
          optionsList.appendChild(buildResponseOptionRow(""));
        }
      }

      function syncResponseOptionsVisibility(form) {
        if (!form) return;
        var typeSelect = form.querySelector('select[name="response_type"]');
        var optionsField = form.querySelector(".response-options-field");
        var optionInputs = Array.from(form.querySelectorAll('input[name="response_options"]'));
        var addOptionBtn = form.querySelector(".add-response-option-btn");
        if (!typeSelect || !optionsField) return;
        var selectedType = (typeSelect.value || "").trim();
        var isMultiple = selectedType === "multiple_choice";
        optionsField.style.display = isMultiple ? "" : "none";
        optionInputs.forEach(function (input) {
          input.disabled = !isMultiple;
        });
        if (addOptionBtn) {
          addOptionBtn.disabled = !isMultiple;
        }
        if (isMultiple) {
          ensureMinimumOptionRows(form, 2);
        }
      }

      function validateUniqueResponseOptions(form) {
        var typeSelect = form.querySelector('select[name="response_type"]');
        if (!typeSelect || (typeSelect.value || "").trim() !== "multiple_choice") {
          return true;
        }
        var seen = {};
        var hasDuplicate = false;
        Array.from(form.querySelectorAll('input[name="response_options"]')).forEach(function (input) {
          var value = (input.value || "").trim();
          input.setCustomValidity("");
          if (!value) return;
          var key = value.toLowerCase();
          if (seen[key]) {
            hasDuplicate = true;
            input.setCustomValidity("Options must be unique.");
          } else {
            seen[key] = true;
          }
        });
        return !hasDuplicate;
      }

      var questionForms = Array.from(document.querySelectorAll('form[action*="/candidate-interview-questions"]'));
      questionForms.forEach(function (form) {
        var addOptionBtn = form.querySelector(".add-response-option-btn");
        var optionsList = form.querySelector(".response-options-list");
        if (addOptionBtn && optionsList) {
          addOptionBtn.addEventListener("click", function () {
            optionsList.appendChild(buildResponseOptionRow(""));
          });
          Array.from(form.querySelectorAll(".remove-response-option-btn")).forEach(function (btn) {
            btn.addEventListener("click", function () {
              var row = btn.closest(".response-option-row");
              if (row) row.remove();
            });
          });
        }
        var typeSelect = form.querySelector('select[name="response_type"]');
        if (!typeSelect) return;
        typeSelect.addEventListener("change", function () {
          syncResponseOptionsVisibility(form);
        });
        form.addEventListener("submit", function (event) {
          if (!validateUniqueResponseOptions(form)) {
            event.preventDefault();
            var invalid = form.querySelector('input[name="response_options"]:invalid');
            if (invalid) invalid.reportValidity();
          }
        });
        syncResponseOptionsVisibility(form);
      });

      Array.from(document.querySelectorAll("[data-check-toggle]")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var mode = (btn.getAttribute("data-check-toggle") || "").trim();
          var group = (btn.getAttribute("data-check-group") || "").trim();
          if (!group) return;
          Array.from(document.querySelectorAll('[data-check-group-input="' + group + '"]')).forEach(function (checkbox) {
            checkbox.checked = mode === "all";
          });
        });
      });

      function reorderCardByPointer(container, draggedCard, clientX) {
        var cards = Array.from(container.querySelectorAll(".name-order-card:not(.dragging)"));
        var insertBefore = null;
        cards.forEach(function (card) {
          var rect = card.getBoundingClientRect();
          var midpoint = rect.left + rect.width / 2;
          if (clientX < midpoint && insertBefore === null) {
            insertBefore = card;
          }
        });
        if (insertBefore) {
          container.insertBefore(draggedCard, insertBefore);
        } else {
          container.appendChild(draggedCard);
        }
      }

      async function persistInterviewNameOrder(container) {
        var locationNumber = (container.getAttribute("data-location-number") || "").trim();
        var statusEl = document.getElementById("interview-name-order-status");
        var cards = Array.from(container.querySelectorAll(".name-order-card"));
        if (!locationNumber || cards.length === 0) return;
        if (statusEl) {
          statusEl.classList.remove("error", "success");
          statusEl.textContent = "Saving order...";
        }
        var orderedIds = cards.map(function (card) {
          return Number((card.getAttribute("data-name-id") || "").trim());
        }).filter(function (id) { return Number.isFinite(id) && id > 0; });
        var resp = await fetch("/admin/locations/" + encodeURIComponent(locationNumber) + "/candidate-interview-names/reorder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderedIds: orderedIds })
        });
        if (!resp.ok) {
          if (statusEl) {
            statusEl.classList.remove("success");
            statusEl.classList.add("error");
            statusEl.textContent = "Unable to save interview type order.";
          }
          return;
        }
        if (statusEl) {
          statusEl.classList.remove("error");
          statusEl.classList.add("success");
          statusEl.textContent = "Interview type order saved.";
        }
      }

      var nameOrderContainer = document.getElementById("interview-name-order");
      if (nameOrderContainer) {
        var draggedCard = null;
        var savingOrder = false;
        Array.from(nameOrderContainer.querySelectorAll(".name-order-card")).forEach(function (card) {
          card.addEventListener("dragstart", function () {
            draggedCard = card;
            card.classList.add("dragging");
          });
          card.addEventListener("dragend", async function () {
            card.classList.remove("dragging");
            if (!draggedCard || savingOrder) {
              draggedCard = null;
              return;
            }
            draggedCard = null;
            savingOrder = true;
            try {
              await persistInterviewNameOrder(nameOrderContainer);
            } finally {
              savingOrder = false;
            }
          });
        });
        nameOrderContainer.addEventListener("dragover", function (event) {
          if (!draggedCard) return;
          event.preventDefault();
          reorderCardByPointer(nameOrderContainer, draggedCard, event.clientX);
        });
      }
    })();
  </script>
</body>
</html>
