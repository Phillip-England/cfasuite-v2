<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Uniform Item</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script defer src="/assets/upload-drop.js"></script>
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background-color: var(--bg); color: var(--fg); font-family: "Manrope", ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2, h3 { margin: 0; font-family: "Space Grotesk", "Manrope", sans-serif; font-weight: 700; line-height: 1.25; }
    h1 { font-size: clamp(1.375rem, 3vw, 1.875rem); }
    h2 { font-size: 1.125rem; }
    p { margin: 0; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card, .panel { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; box-shadow: var(--shadow); }
    @media (max-width: 639px) { .card, .panel { padding: 1rem; } }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea { display: block; width: 100%; min-height: 2.375rem; padding: 0.5rem 0.75rem; font: 0.875rem/1.5 inherit; color: var(--fg); background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; transition: border-color 150ms, box-shadow 150ms; }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]):focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    html.dark input:focus, html.dark select:focus, html.dark textarea:focus { box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.375rem; }
    .text-muted { color: var(--muted-fg); font-size: 0.875rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.375rem; min-height: 2.375rem; padding: 0.5rem 0.875rem; font: 600 0.875rem/1.25 inherit; border-radius: 0.375rem; border: 1px solid transparent; cursor: pointer; transition: 150ms; white-space: nowrap; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; }
    .btn-secondary { background-color: var(--bg); color: var(--fg); border-color: var(--border); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--muted); }
    .btn-danger { background-color: transparent; color: var(--danger); border-color: var(--border); }
    .btn-danger:hover:not(:disabled) { background-color: rgba(220,38,38,.08); border-color: var(--danger); }
    .btn-sm { min-height: 2rem; padding: 0.3125rem 0.625rem; font-size: 0.8125rem; }
    .hub { display: grid; gap: 0.75rem; grid-template-columns: 1fr 1fr; margin-bottom: 1rem; }
    .hub-btn { width: 100%; text-align: left; padding: 0.875rem 1rem; background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; cursor: pointer; font-family: inherit; color: var(--fg); transition: 150ms; }
    .hub-btn:hover { background-color: var(--muted); }
    .hub-btn.active { background-color: var(--muted); border-color: var(--primary); }
    .hub-btn strong { display: block; font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.25rem; }
    .hub-btn span { display: block; font-size: 0.8125rem; color: var(--muted-fg); }
    .section[data-panel] { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .section[data-panel].active { display: block; }
    .back { font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); display: inline-flex; align-items: center; gap: 0.25rem; margin-bottom: 1rem; }
    .back:hover { color: var(--fg); text-decoration: none; }
    .notice, .msg { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.75rem; }
    .notice.ok, .msg.ok { color: var(--success); }
    .notice.error, .msg.error { color: var(--danger); }
    .gallery-help { font-size: 0.8125rem; color: var(--muted-fg); margin-bottom: 0.5rem; }
    .gallery { display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); margin-top: 0.75rem; }
    .gallery-card { position: relative; border: 1px solid var(--border); border-radius: 0.5rem; overflow: hidden; background: var(--bg); min-height: 132px; }
    .gallery-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; background: var(--muted); }
    .gallery-card[draggable="true"] { cursor: grab; }
    .gallery-card.dragging { opacity: 0.45; }
    .gallery-card.drag-over { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,79,113,.2); }
    .card-badge { position: absolute; left: 6px; bottom: 6px; background: rgba(0,0,0,.65); color: #fff; border-radius: 999px; padding: 2px 6px; font-size: 0.6875rem; font-weight: 600; }
    .remove-form { position: absolute; top: 4px; right: 4px; margin: 0; }
    .remove-btn { width: 22px; height: 22px; min-height: 22px; border-radius: 999px; border: 1px solid rgba(255,255,255,.7); background: rgba(0,0,0,.65); color: #fff; font-size: 0.875rem; padding: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
    .preview-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 180px)); gap: 0.75rem; margin-top: 0.75rem; }
    .preview-box { border: 1px dashed var(--border); border-radius: 0.5rem; background: var(--bg); padding: 0.5rem; }
    .preview-label { display: block; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; color: var(--muted-fg); margin-bottom: 0.375rem; letter-spacing: 0.05em; }
    .preview-image { width: 100%; max-height: 320px; border-radius: 0.375rem; object-fit: contain; background: var(--muted); border: 1px solid var(--border); display: block; }
    .crop-tools { display: none; gap: 0.5rem; position: relative; z-index: 20; }
    .crop-tools.is-active { display: grid; }
    .crop-result-box { display: none; }
    .crop-result-box.is-active { display: block; }
    .crop-stage { position: relative; width: 100%; }
    .crop-selection { position: absolute; border: 2px solid #fff; box-shadow: 0 0 0 9999px rgba(0,0,0,.4); border-radius: 0.375rem; cursor: move; touch-action: none; display: none; }
    .crop-selection.is-active { display: block; }
    .crop-selection.is-locked { box-shadow: none; cursor: default; }
    .crop-selection.is-locked .crop-handle { display: none; }
    .crop-handle { position: absolute; width: 18px; height: 18px; right: -9px; bottom: -9px; border-radius: 999px; border: 2px solid #fff; background: var(--primary); cursor: nwse-resize; touch-action: none; }
    input[type="file"] { width: 100%; color: var(--muted-fg); }
    input[type="file"]::file-selector-button {
      margin-right: 0.625rem;
      border: 1px solid var(--border);
      background: var(--muted);
      color: var(--fg);
      border-radius: 0.375rem;
      padding: 0.375rem 0.625rem;
      font: 600 0.8125rem/1.25 inherit;
      cursor: pointer;
      transition: 150ms;
    }
    input[type="file"]::file-selector-button:hover { border-color: var(--primary); }
    input[type="file"]::-webkit-file-upload-button {
      margin-right: 0.625rem;
      border: 1px solid var(--border);
      background: var(--muted);
      color: var(--fg);
      border-radius: 0.375rem;
      padding: 0.375rem 0.625rem;
      font: 600 0.8125rem/1.25 inherit;
      cursor: pointer;
      transition: 150ms;
    }
    input[type="file"]::-webkit-file-upload-button:hover { border-color: var(--primary); }
    form { display: grid; gap: 0.75rem; }
  </style>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors">

  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
        <a href="/admin/locations/{{ .Location.Number }}/uniforms" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Uniforms</a>
        <a href="/admin/locations/{{ .Location.Number }}/uniform-items/{{ .UniformItem.ID }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Item</a>
      </nav>
      <div class="flex items-center gap-2 shrink-0">
        <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
        <button id="theme-toggle" type="button" aria-label="Toggle theme" class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <button id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-mobile" class="md:hidden h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <span class="sr-only">Open menu</span>
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </button>
      </div>
    </div>
    <div id="nav-mobile" class="hidden md:hidden border-t border-zinc-200 dark:border-zinc-800 px-4 py-2 bg-white dark:bg-zinc-950 flex-col gap-1">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
      <a href="/admin/locations/{{ .Location.Number }}/uniforms" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Uniforms</a>
      <a href="/admin/locations/{{ .Location.Number }}/uniform-items/{{ .UniformItem.ID }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Item</a>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto max-w-[1000px]">
      <div class="card">
        <a class="back" href="/admin/locations/{{ .Location.Number }}/uniforms">&#8592; Back to Uniforms</a>
        <h1 style="margin-bottom: 0.25rem;">{{ .UniformItem.Name }}</h1>
        <p class="text-muted" style="margin-bottom: 1rem;">{{ .Location.Name }} ({{ .Location.Number }})</p>
        {{ if .SuccessMessage }}<p class="msg ok">{{ .SuccessMessage }}</p>{{ end }}
        {{ if .Error }}<p class="msg error">{{ .Error }}</p>{{ end }}

        <div class="hub">
          <button class="hub-btn" type="button" data-target="details-panel">
            <strong>Item Details</strong>
            <span>Update name, price, and size options.</span>
          </button>
          {{ if ne .UniformItem.SystemKey "shoes" }}
          <button class="hub-btn" type="button" data-target="gallery-panel">
            <strong>Gallery</strong>
            <span>Add photos, reorder by drag/drop, remove with the corner &times;.</span>
          </button>
          {{ end }}
        </div>

        <section class="section" data-panel="details-panel">
          <h2 style="margin-bottom: 1rem;">Item Details</h2>
          {{ if eq .UniformItem.SystemKey "shoes" }}
          <p class="text-muted" style="margin-bottom:0.85rem;">This is a system item managed by the developer. To change the icon, replace `internal/clientapp/assets/shoe.svg`.</p>
          {{ end }}
          {{ if ne .UniformItem.SystemKey "shoes" }}
          <form method="post" action="/admin/locations/{{ .Location.Number }}/uniform-items/{{ .UniformItem.ID }}/update">
            <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
            <input type="hidden" name="next" value="/admin/locations/{{ .Location.Number }}/uniform-items/{{ .UniformItem.ID }}">
            <div>
              <label for="item-name">Name</label>
              <input id="item-name" type="text" name="name" value="{{ .UniformItem.Name }}" required>
            </div>
            <div>
              <label for="item-price">Price (USD)</label>
              <input id="item-price" type="text" name="price" value="{{ printf "%.2f" .UniformItem.Price }}" required>
            </div>
            <div>
              <label for="item-size-fields">Size Fields (optional)</label>
              <textarea id="item-size-fields" name="size_fields" rows="4" placeholder="Size: XS,S,M,L&#10;Waist: 28,30,32,34&#10;Height: 30,32,34">{{- range .UniformItem.SizeFields -}}{{ .Label }}: {{ range $idx, $option := .Options }}{{ if $idx }},{{ end }}{{ $option }}{{ end }}
{{- end -}}</textarea>
              <p class="text-muted" style="margin-top:0.25rem;">One field per line using <strong>Label: option1, option2</strong>.</p>
            </div>
            <div>
              <button type="submit" class="btn btn-primary">Save Item</button>
            </div>
          </form>
          {{ end }}
        </section>

        {{ if ne .UniformItem.SystemKey "shoes" }}
        <section class="section" data-panel="gallery-panel">
          <h2 style="margin-bottom: 1rem;">Add Gallery Images</h2>
          <form method="post" enctype="multipart/form-data" action="/admin/locations/{{ .Location.Number }}/uniform-items/{{ .UniformItem.ID }}/images">
            <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
            <input type="hidden" id="crop_x" name="crop_x" value="0">
            <input type="hidden" id="crop_y" name="crop_y" value="0">
            <input type="hidden" id="crop_size" name="crop_size" value="0">
            <div>
              <label for="photo_file">Upload Image</label>
              <input id="photo_file" type="file" name="photo_file" accept="image/png,image/jpeg,image/webp" required>
            </div>
            <div class="preview-row">
              <div class="preview-box">
                <span class="preview-label">Selected Image</span>
                <div class="crop-stage">
                  <img id="photo-preview" class="preview-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23888888' font-family='Manrope' font-size='14'%3ESelect Image%3C%2Ftext%3E%3C%2Fsvg%3E" alt="Selected image preview">
                  <div id="crop-selection" class="crop-selection">
                    <div id="crop-handle" class="crop-handle"></div>
                  </div>
                </div>
              </div>
              <div id="crop-result-box" class="preview-box crop-result-box">
                <span class="preview-label">Cropped Result</span>
                <canvas id="crop-result" class="preview-image" width="180" height="180"></canvas>
              </div>
            </div>
            <div id="crop-tools" class="crop-tools">
              <p class="text-muted" style="margin:0;">Drag the crop box. Use the bottom-right handle to resize.</p>
              <button id="confirm-crop" type="button" class="btn btn-secondary btn-sm">Confirm Crop</button>
            </div>
            <div>
              <button id="add-image-btn" type="submit" class="btn btn-primary" disabled>Add Image</button>
            </div>
          </form>

          <h2 style="margin-top: 1.25rem; margin-bottom: 0.5rem;">Current Gallery</h2>
          <p class="gallery-help">Drag cards to reorder. Tap the corner <strong>&times;</strong> to remove an image.</p>
          <div id="gallery" class="gallery" data-location-number="{{ .Location.Number }}" data-item-id="{{ .UniformItem.ID }}" data-csrf="{{ .CSRF }}">
            {{ if .UniformItem.Images }}
              {{ range .UniformItem.Images }}
                <div class="gallery-card" {{ if gt .ID 0 }}draggable="true" data-image-id="{{ .ID }}"{{ end }}>
                  <img src="data:{{ .ImageMime }};base64,{{ .ImageData }}" alt="{{ $.UniformItem.Name }}">
                  {{ if gt .ID 0 }}
                    <span class="card-badge">Drag</span>
                    <form class="remove-form" method="post" action="/admin/locations/{{ $.Location.Number }}/uniform-items/{{ $.UniformItem.ID }}/images/{{ .ID }}/delete" onsubmit="return confirm('Remove this image?');">
                      <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                      <button class="remove-btn" type="submit" aria-label="Remove image">&times;</button>
                    </form>
                  {{ end }}
                </div>
              {{ end }}
            {{ else }}
              <p class="text-muted">No gallery images found.</p>
            {{ end }}
          </div>
        </section>
        {{ end }}
      </div>
    </div>
  </div>

  <script>
    const photoFile = document.getElementById("photo_file");
    const preview = document.getElementById("photo-preview");
    const cropTools = document.getElementById("crop-tools");
    const cropResultBox = document.getElementById("crop-result-box");
    const cropCanvas = document.getElementById("crop-result");
    const cropCtx = cropCanvas.getContext("2d");
    const cropSelection = document.getElementById("crop-selection");
    const cropHandle = document.getElementById("crop-handle");
    const cropX = document.getElementById("crop_x");
    const cropY = document.getElementById("crop_y");
    const cropSize = document.getElementById("crop_size");
    const confirmCropBtn = document.getElementById("confirm-crop");
    const addImageBtn = document.getElementById("add-image-btn");
    let naturalWidth = 0;
    let naturalHeight = 0;
    let fileSelected = false;
    let cropRect = { x: 0, y: 0, size: 0 };
    let dragMode = "";
    let pointerStart = { x: 0, y: 0 };
    let rectStart = { x: 0, y: 0, size: 0 };
    let cropConfirmed = false;
    let cropLocked = false;
    const galleryEl = document.getElementById("gallery");
    let draggedItemEl = null;
    let reorderInFlight = false;
    const hubButtons = Array.from(document.querySelectorAll(".hub-btn"));
    const panels = Array.from(document.querySelectorAll('.section[data-panel]'));

    function showPanel(panelName) {
      hubButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.target === panelName));
      panels.forEach((panel) => panel.classList.toggle("active", panel.dataset.panel === panelName));
      if (window.location.hash !== "#" + panelName) {
        window.history.replaceState(null, "", "#" + panelName);
      }
    }

    hubButtons.forEach((btn) => {
      btn.addEventListener("click", () => showPanel(btn.dataset.target));
    });
    const initialPanel = (window.location.hash || "").replace("#", "");
    if (initialPanel && panels.some((panel) => panel.dataset.panel === initialPanel)) {
      showPanel(initialPanel);
    } else {
      showPanel("gallery-panel");
    }

    function clamp(value, min, max) { return Math.max(min, Math.min(max, value)); }
    function setCropModeActive(active) {
      cropTools.classList.toggle("is-active", active);
      cropResultBox.classList.toggle("is-active", active);
      cropSelection.classList.toggle("is-active", active);
      if (!active) cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
      setCropConfirmed(false);
    }
    function setCropConfirmed(value) {
      cropConfirmed = value;
      cropLocked = value;
      cropSelection.classList.toggle("is-locked", value);
      addImageBtn.disabled = !value;
      confirmCropBtn.textContent = value ? "Crop Confirmed" : "Confirm Crop";
    }
    function syncCropToHidden() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (displayWidth <= 0 || displayHeight <= 0 || naturalWidth <= 0 || naturalHeight <= 0) return;
      const scaleX = naturalWidth / displayWidth;
      const scaleY = naturalHeight / displayHeight;
      cropX.value = String(Math.round(cropRect.x * scaleX));
      cropY.value = String(Math.round(cropRect.y * scaleY));
      cropSize.value = String(Math.round(cropRect.size * Math.min(scaleX, scaleY)));
    }
    function renderCropSelection() {
      cropSelection.style.left = `${cropRect.x}px`;
      cropSelection.style.top = `${cropRect.y}px`;
      cropSelection.style.width = `${cropRect.size}px`;
      cropSelection.style.height = `${cropRect.size}px`;
    }
    function drawCropPreview() {
      syncCropToHidden();
      const x = Number(cropX.value || "0");
      const y = Number(cropY.value || "0");
      const size = Number(cropSize.value || "0");
      if (size <= 0) return;
      cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
      cropCtx.drawImage(preview, x, y, size, size, 0, 0, cropCanvas.width, cropCanvas.height);
    }
    function initializeCropControls() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      const minDim = Math.min(displayWidth, displayHeight);
      const initial = Math.max(48, Math.floor(minDim * 0.72));
      cropRect.size = Math.min(initial, minDim);
      cropRect.x = Math.floor((displayWidth - cropRect.size) / 2);
      cropRect.y = Math.floor((displayHeight - cropRect.size) / 2);
      renderCropSelection();
      drawCropPreview();
    }
    function onPointerMove(event) {
      if (!dragMode || cropLocked) return;
      const dx = event.clientX - pointerStart.x;
      const dy = event.clientY - pointerStart.y;
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (dragMode === "move") {
        cropRect.x = clamp(rectStart.x + dx, 0, displayWidth - rectStart.size);
        cropRect.y = clamp(rectStart.y + dy, 0, displayHeight - rectStart.size);
      } else if (dragMode === "resize") {
        const maxSize = Math.min(displayWidth - rectStart.x, displayHeight - rectStart.y);
        cropRect.size = clamp(rectStart.size + Math.max(dx, dy), 48, maxSize);
      }
      setCropConfirmed(false);
      renderCropSelection();
      drawCropPreview();
      event.preventDefault();
    }
    function onPointerUp() {
      dragMode = "";
      window.removeEventListener("pointermove", onPointerMove);
      window.removeEventListener("pointerup", onPointerUp);
    }
    cropSelection.addEventListener("pointerdown", (event) => {
      if (!fileSelected || cropLocked) return;
      dragMode = event.target === cropHandle ? "resize" : "move";
      pointerStart = { x: event.clientX, y: event.clientY };
      rectStart = { x: cropRect.x, y: cropRect.y, size: cropRect.size };
      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp);
      event.preventDefault();
    });
    photoFile.addEventListener("change", () => {
      const file = photoFile.files && photoFile.files[0];
      if (!file) {
        fileSelected = false;
        setCropModeActive(false);
        cropX.value = "0";
        cropY.value = "0";
        cropSize.value = "0";
        return;
      }
      fileSelected = true;
      const reader = new FileReader();
      reader.onload = () => { preview.src = String(reader.result || ""); };
      reader.readAsDataURL(file);
    });
    preview.addEventListener("load", () => {
      if (!fileSelected) return;
      naturalWidth = preview.naturalWidth || preview.width;
      naturalHeight = preview.naturalHeight || preview.height;
      if (naturalWidth <= 0 || naturalHeight <= 0) return;
      setCropModeActive(true);
      initializeCropControls();
      setCropConfirmed(false);
    });
    confirmCropBtn.addEventListener("click", () => {
      if (!fileSelected) return;
      drawCropPreview();
      setCropConfirmed(true);
    });

    async function moveImageByDirection(locationNumber, itemID, imageID, direction, csrfToken) {
      const body = new URLSearchParams();
      body.set("csrf_token", csrfToken);
      body.set("direction", direction);
      body.set("next", window.location.pathname);
      const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/uniform-items/${encodeURIComponent(itemID)}/images/${encodeURIComponent(imageID)}/move`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
      if (!response.ok) {
        throw new Error("Unable to reorder image");
      }
    }

    async function persistDraggedOrder(imageID, fromIndex, toIndex) {
      if (!galleryEl) return;
      if (fromIndex === toIndex) return;
      const locationNumber = galleryEl.dataset.locationNumber || "";
      const itemID = galleryEl.dataset.itemId || "";
      const csrfToken = galleryEl.dataset.csrf || "";
      if (!locationNumber || !itemID || !csrfToken) return;
      const steps = Math.abs(toIndex - fromIndex);
      const direction = toIndex > fromIndex ? "down" : "up";
      for (let i = 0; i < steps; i++) {
        await moveImageByDirection(locationNumber, itemID, imageID, direction, csrfToken);
      }
    }

    if (galleryEl) {
      const draggableItems = () => Array.from(galleryEl.querySelectorAll('.gallery-card[data-image-id]'));
      galleryEl.addEventListener("dragstart", (event) => {
        const target = event.target.closest(".gallery-card[data-image-id]");
        if (!target || reorderInFlight) return;
        draggedItemEl = target;
        target.classList.add("dragging");
        event.dataTransfer.effectAllowed = "move";
      });
      galleryEl.addEventListener("dragend", (event) => {
        const target = event.target.closest(".gallery-card[data-image-id]");
        if (target) target.classList.remove("dragging");
        galleryEl.querySelectorAll(".gallery-card.drag-over").forEach((el) => el.classList.remove("drag-over"));
      });
      galleryEl.addEventListener("dragover", (event) => {
        const target = event.target.closest(".gallery-card[data-image-id]");
        if (!draggedItemEl || !target || draggedItemEl === target || reorderInFlight) return;
        event.preventDefault();
        event.dataTransfer.dropEffect = "move";
        galleryEl.querySelectorAll(".gallery-card.drag-over").forEach((el) => el.classList.remove("drag-over"));
        target.classList.add("drag-over");
      });
      galleryEl.addEventListener("drop", async (event) => {
        const target = event.target.closest(".gallery-card[data-image-id]");
        if (!draggedItemEl || !target || draggedItemEl === target || reorderInFlight) return;
        event.preventDefault();
        galleryEl.querySelectorAll(".gallery-card.drag-over").forEach((el) => el.classList.remove("drag-over"));
        const itemsBefore = draggableItems();
        const fromIndex = itemsBefore.indexOf(draggedItemEl);
        const toIndex = itemsBefore.indexOf(target);
        if (fromIndex < 0 || toIndex < 0 || fromIndex === toIndex) return;

        reorderInFlight = true;
        const imageID = draggedItemEl.dataset.imageId;
        try {
          await persistDraggedOrder(imageID, fromIndex, toIndex);
          window.location.reload();
        } catch (_) {
          window.alert("Unable to reorder image right now.");
          window.location.reload();
        } finally {
          reorderInFlight = false;
        }
      });
    }
    setCropModeActive(false);
  </script>

  <script>
    (function () {
      var storageKey = "cfasuite-theme";
      var root = document.documentElement;
      var toggle = document.getElementById("theme-toggle");
      var navToggle = document.getElementById("nav-toggle");
      var navMobile = document.getElementById("nav-mobile");
      if (toggle) {
        toggle.addEventListener("click", function () {
          var isDark = root.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
        });
      }
      if (navToggle && navMobile) {
        navToggle.addEventListener("click", function () {
          var expanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", expanded ? "false" : "true");
          navMobile.classList.toggle("hidden", expanded);
          if (!expanded) { navMobile.style.display = "flex"; } else { navMobile.style.removeProperty("display"); }
        });
      }
    })();
  </script>

</body>
</html>
