<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ .CSRF }}">
  <title>Employee Details</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script defer src="/assets/upload-drop.js"></script>
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background-color: var(--bg); color: var(--fg); font-family: "Manrope", ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2, h3 { margin: 0; font-family: "Space Grotesk", "Manrope", sans-serif; font-weight: 700; line-height: 1.25; }
    h1 { font-size: clamp(1.375rem, 3vw, 1.875rem); }
    h2 { font-size: 1.125rem; }
    p { margin: 0; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card, .panel { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; box-shadow: var(--shadow); }
    @media (max-width: 639px) { .card, .panel { padding: 1rem; } }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea { display: block; width: 100%; min-height: 2.375rem; padding: 0.5rem 0.75rem; font: 0.875rem/1.5 inherit; color: var(--fg); background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; transition: border-color 150ms, box-shadow 150ms; }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]):focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    html.dark input:focus, html.dark select:focus, html.dark textarea:focus { box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.375rem; }
    .label-missing { color: var(--danger); }
    .label-missing::after { content: " *required"; font-size: 0.75rem; font-weight: 700; margin-left: 0.25rem; }
    .input-missing { border-color: var(--danger) !important; background: rgba(220, 38, 38, 0.06); }
    .text-muted { color: var(--muted-fg); font-size: 0.875rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.375rem; min-height: 2.375rem; padding: 0.5rem 0.875rem; font: 600 0.875rem/1.25 inherit; border-radius: 0.375rem; border: 1px solid transparent; cursor: pointer; transition: 150ms; white-space: nowrap; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; }
    .btn-secondary { background-color: var(--bg); color: var(--fg); border-color: var(--border); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--muted); }
    .btn-sm { min-height: 2rem; padding: 0.3125rem 0.625rem; font-size: 0.8125rem; }

    /* Back link */
    .back { font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); display: inline-flex; align-items: center; gap: 0.25rem; margin-bottom: 1rem; }
    .back:hover { color: var(--fg); text-decoration: none; }

    /* Submenu */
    .submenu { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0 0; }
    .submenu-btn { padding: 0.375rem 0.75rem; font-size: 0.8125rem; font-weight: 500; background-color: transparent; border: 1px solid var(--border); border-radius: 0.375rem; cursor: pointer; font-family: inherit; color: var(--muted-fg); transition: 150ms; }
    .submenu-btn:hover { background-color: var(--muted); color: var(--fg); }
    .submenu-btn.active { background-color: var(--fg); color: var(--bg); border-color: var(--fg); }

    /* Panel */
    .panel { background: none; border: none; padding: 0; box-shadow: none; display: none; border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 0; }
    .panel.active { display: block; }

    /* Info grid */
    .grid { display: grid; grid-template-columns: 160px 1fr; gap: 0.5rem 1rem; font-size: 0.875rem; margin-bottom: 1rem; }
    .label { color: var(--muted-fg); font-weight: 500; }
    .value { font-weight: 600; }

    /* Employee detail layout */
    .profile-header { display: grid; gap: 0.75rem; margin-top: 0.5rem; }
    .profile-kicker { color: var(--muted-fg); font-size: 0.8rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; }
    .profile-name-row { display: flex; gap: 0.625rem; align-items: center; flex-wrap: wrap; }
    .status-pill { display: inline-flex; align-items: center; border: 1px solid var(--border); border-radius: 999px; padding: 0.2rem 0.625rem; font-size: 0.75rem; font-weight: 700; }
    .status-pill.new-hire { color: #b45309; border-color: rgba(217, 119, 6, 0.45); background: rgba(217, 119, 6, 0.12); }
    .status-pill.active { color: var(--success); border-color: rgba(22, 163, 74, 0.45); background: rgba(22, 163, 74, 0.1); }
    .status-pill.archived { color: var(--muted-fg); }
    .summary-grid { display: grid; gap: 0.625rem; margin-top: 1rem; }
    @media (min-width: 640px) { .summary-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .summary-card { border: 1px solid var(--border); border-radius: 0.625rem; background: var(--bg); padding: 0.75rem 0.875rem; display: grid; gap: 0.2rem; min-height: 4.25rem; }
    .summary-label { font-size: 0.75rem; letter-spacing: 0.03em; text-transform: uppercase; color: var(--muted-fg); font-weight: 700; }
    .summary-value { font-size: 0.95rem; font-weight: 700; color: var(--fg); word-break: break-word; }
    .section-stack { display: grid; gap: 0.875rem; margin-top: 1rem; }
    .section-card { border: 1px solid var(--border); border-radius: 0.625rem; background: var(--bg); padding: 0.95rem; display: grid; gap: 0.625rem; }
    .section-card-title { font-size: 0.875rem; font-weight: 700; margin: 0; }
    .section-card-sub { color: var(--muted-fg); font-size: 0.8125rem; margin: 0; }
    .field-grid { display: grid; gap: 0.625rem; }
    @media (min-width: 640px) { .field-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .edit-form-grid { display: grid; gap: 0.75rem; }
    @media (min-width: 640px) { .edit-form-grid.two-col { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 640px) { .edit-form-grid.three-col { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .readonly-pill { display: inline-flex; align-items: center; min-height: 2.375rem; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid var(--border); background: var(--muted); color: var(--muted-fg); font-size: 0.875rem; font-weight: 600; }

    /* Photo */
    .photo-preview { width: 180px; max-width: 100%; height: auto; max-height: 280px; border-radius: 0.5rem; border: 1px solid var(--border); object-fit: contain; display: block; background: var(--muted); }
    .crop-stage { position: relative; width: 180px; max-width: 100%; }
    .crop-selection { position: absolute; border: 2px solid #fff; box-shadow: 0 0 0 9999px rgba(0,0,0,.4); border-radius: 0.375rem; cursor: move; touch-action: none; display: none; }
    .crop-selection.is-active { display: block; }
    .crop-selection.is-locked { box-shadow: none; cursor: default; }
    .crop-selection.is-locked .crop-handle { display: none; }
    .crop-handle { position: absolute; width: 18px; height: 18px; right: -9px; bottom: -9px; border-radius: 999px; border: 2px solid #fff; background: var(--primary); cursor: nwse-resize; touch-action: none; }
    .preview-row { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .preview-box { display: grid; gap: 0.375rem; }
    .preview-box.crop-result-box { display: none; }
    .preview-box.crop-result-box.is-active { display: grid; }
    .preview-label { font-size: 0.75rem; font-weight: 600; color: var(--muted-fg); }
    .crop-tools { display: none; gap: 0.5rem; position: relative; z-index: 20; }
    .crop-tools.is-active { display: grid; }
    .button-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .controls { display: grid; gap: 0.5rem; margin-top: 0.625rem; }
    .controls label { font-size: 0.8rem; color: var(--muted-fg); font-weight: 600; }
    .controls input[type="range"] { width: 100%; }
    .upload-link-box { margin-top: 0.625rem; font-size: 0.8125rem; color: var(--muted-fg); word-break: break-all; }

    /* Copy row */
    .copy-row { display: grid; gap: 0.5rem; grid-template-columns: 1fr; }
    @media (min-width: 640px) { .copy-row { grid-template-columns: 1fr auto auto; align-items: center; } }

    /* Segment inputs */
    .segment-row { display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 0.375rem; align-items: center; }
    .segment-sep { color: var(--muted-fg); font-weight: 700; text-align: center; user-select: none; }
    .segment { text-align: center; letter-spacing: 0.06em; }

    /* Paperwork cards */
    .paperwork-cards { display: grid; gap: 0.625rem; margin-top: 0.625rem; }
    .paperwork-card { border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg); padding: 0.875rem; display: grid; gap: 0.5rem; }
    .paperwork-card-title { margin: 0; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; color: var(--muted-fg); }
    .paperwork-meta { margin: 0; color: var(--muted-fg); font-size: 0.875rem; }
    .paperwork-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .doc-link { color: var(--primary); font-weight: 600; font-size: 0.875rem; }
    .doc-link:hover { text-decoration: underline; }

    /* Paperwork switch */
    .paperwork-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin: 0.5rem 0 0.75rem; }
    .paperwork-btn { border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.5rem 0.75rem; background: var(--bg); font: 600 0.8125rem/1 inherit; color: var(--fg); cursor: pointer; transition: 150ms; }
    .paperwork-btn:hover { background-color: var(--muted); }
    .paperwork-btn.active { background-color: var(--fg); color: var(--bg); border-color: var(--fg); }
    .paperwork-form-card { display: none; border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.875rem; background: var(--bg); }
    .paperwork-form-card.active { display: block; }

    /* Signature pad */
    .signature-pad-shell { border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; background: var(--muted); display: grid; gap: 0.5rem; }
    .signature-pad { width: 100%; height: 170px; border: 1px solid var(--border); border-radius: 0.375rem; background: var(--bg); touch-action: none; }
    .signature-status { min-height: 1.125rem; color: var(--muted-fg); font-size: 0.8125rem; font-weight: 600; }

    /* Status messages */
    .message { margin-top: 0.5rem; min-height: 1.3em; font-size: 0.875rem; font-weight: 500; }
    .message.ok { color: var(--success); }
    .message.error { color: var(--danger); }
    .notice.ok { color: var(--success); font-weight: 500; }
    .notice.error { color: var(--danger); font-weight: 500; }

    /* Hint text */
    .hint { color: var(--muted-fg); font-size: 0.8125rem; margin-bottom: 0.375rem; }

    /* Sub heading */
    .sub { color: var(--muted-fg); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0; }
  </style>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors">

  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
        <a href="/admin/locations/{{ .Location.Number }}/employees" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Employees</a>
        <a href="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Employee</a>
      </nav>
      <div class="flex items-center gap-2 shrink-0">
        <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
        <button id="theme-toggle" type="button" aria-label="Toggle theme" class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <button id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-mobile" class="md:hidden h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <span class="sr-only">Open menu</span>
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </button>
      </div>
    </div>
    <div id="nav-mobile" class="hidden md:hidden border-t border-zinc-200 dark:border-zinc-800 px-4 py-2 bg-white dark:bg-zinc-950 flex-col gap-1">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
      <a href="/admin/locations/{{ .Location.Number }}/employees" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Employees</a>
      <a href="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Employee</a>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto max-w-[720px]">
      <div class="card">

        <a class="back" href="{{ if .IsArchivedEmployee }}/admin/locations/{{ .Location.Number }}/employees/archived{{ else }}/admin/locations/{{ .Location.Number }}/employees{{ end }}">&#8592; Back to {{ if .IsArchivedEmployee }}Terminated Employees{{ else }}Employees{{ end }}</a>

        <div class="profile-header">
          <p class="profile-kicker">Employee Profile</p>
          <div class="profile-name-row">
            <h1>{{ .Employee.FirstName }} {{ .Employee.LastName }}</h1>
            <span class="status-pill {{ if .IsArchivedEmployee }}archived{{ else if .Employee.HasCompletedPaperwork }}active{{ else }}new-hire{{ end }}">{{ if .IsArchivedEmployee }}Terminated{{ else if .Employee.HasCompletedPaperwork }}Active{{ else }}New Hire{{ end }}</span>
          </div>
          <p class="sub">Location {{ .Location.Name }} ({{ .Location.Number }}){{ if .IsArchivedEmployee }} &bull; Terminated {{ .Employee.ArchivedAt }}{{ end }}</p>
        </div>

        {{ if not .IsNewHireEmployee }}
        <section class="submenu">
          <button class="submenu-btn" type="button" data-target="employee">Employee</button>
          {{ if not .IsArchivedEmployee }}
            <button class="submenu-btn" type="button" data-target="paperwork-upload">{{ if .IsNewHireEmployee }}Paperwork Link{{ else if .IsActiveEmployee }}Update Paperwork{{ end }}</button>
          {{ end }}
          <button class="submenu-btn" type="button" data-target="paperwork-view">View Paperwork</button>
        </section>
        {{ end }}

        {{ if or .SuccessMessage .Error }}
        <div class="message {{ if .Error }}error{{ else }}ok{{ end }}">{{ if .Error }}{{ .Error }}{{ else }}{{ .SuccessMessage }}{{ end }}</div>
        {{ end }}
        {{ if and (not .IsArchivedEmployee) .HasEmployeeMissingProfileFields }}
        <div class="message error" style="margin-top:0.5rem;">
          {{ if .IsNewHireEmployee }}
          This new hire must complete paperwork before becoming active.
          {{ else }}
          Employee profile is missing required fields: {{ range $idx, $field := .EmployeeMissingProfileFields }}{{ if $idx }}, {{ end }}{{ $field }}{{ end }}.
          {{ end }}
        </div>
        {{ end }}
        {{ if and (not .IsArchivedEmployee) .IsNewHireEmployee }}
        <div class="section-card" style="margin-top:0.75rem;">
          <h2 class="section-card-title">Complete New-Hire Paperwork</h2>
          <p class="section-card-sub">This profile is read-only until paperwork is completed. Use the paperwork link to move this team member to Active.</p>
          <div style="margin-top:0.625rem;">
            <div class="copy-row">
              <input id="paperwork-link-input" type="text" value="{{ .EmployeePaperworkLink }}" readonly>
              <button id="copy-paperwork-link" class="btn btn-secondary btn-sm" type="button">Copy Link</button>
              <button id="view-paperwork-link" class="btn btn-secondary btn-sm" type="button">View Form</button>
            </div>
            <div id="paperwork-link-box" class="upload-link-box"></div>
          </div>
        </div>
        {{ end }}

        <section class="panel" data-panel="employee">
          <div class="summary-grid">
            <article class="summary-card">
              <p class="summary-label">Time Punch Name</p>
              <p class="summary-value">{{ .Employee.TimePunchName }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Employee Number</p>
              <p class="summary-value">{{ if .Employee.EmployeeNumber }}{{ .Employee.EmployeeNumber }}{{ else }}-{{ end }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Birthday</p>
              <p class="summary-value">{{ .Employee.Birthday }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Pay Type</p>
              <p class="summary-value">{{ if .Employee.PayType }}{{ .Employee.PayType }}{{ else }}-{{ end }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Pay</p>
              <p class="summary-value">{{ if gt .Employee.PayAmountCents 0 }}{{ .Employee.PayAmountCents }} cents{{ else }}-{{ end }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Email</p>
              <p class="summary-value">{{ if .Employee.Email }}{{ .Employee.Email }}{{ else }}-{{ end }}</p>
            </article>
            <article class="summary-card">
              <p class="summary-label">Phone</p>
              <p class="summary-value">{{ if .Employee.Phone }}{{ .Employee.Phone }}{{ else }}-{{ end }}</p>
            </article>
          </div>

          {{ if .IsArchivedEmployee }}
          <p class="hint" style="margin-top:0.75rem;">Terminated employee profiles are read-only.</p>
          {{ else if .IsNewHireEmployee }}
          <p class="hint" style="margin-top:0.75rem;">New hire profiles are read-only. Complete paperwork to activate this employee.</p>
          {{ else }}
          <p class="hint" style="margin-top:0.75rem;">You can review and edit this employee in this section.</p>
          {{ end }}
        </section>

        {{ if .IsActiveEmployee }}
        <section class="panel" data-panel="employee">
          <section class="section-card">
            <h2 class="section-card-title">Edit Employee Details</h2>
            <p class="section-card-sub">Use this form to update employee details.</p>
            <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/details/update" style="display:grid; gap:1rem;">
              <input type="hidden" name="csrf_token" value="{{ .CSRF }}">

              <div class="edit-form-grid two-col">
                <div>
                  <label>Time Punch Name</label>
                  <div class="readonly-pill">{{ .Employee.TimePunchName }}</div>
                </div>
              </div>

              <div class="edit-form-grid two-col">
                <div>
                  <label for="edit-first-name" class="{{ if index .EmployeeMissingProfileFieldSet "First Name" }}label-missing{{ end }}">First Name</label>
                  <input id="edit-first-name" name="first_name" value="{{ .Employee.FirstName }}" required class="{{ if index .EmployeeMissingProfileFieldSet "First Name" }}input-missing{{ end }}">
                </div>
                <div>
                  <label for="edit-last-name" class="{{ if index .EmployeeMissingProfileFieldSet "Last Name" }}label-missing{{ end }}">Last Name</label>
                  <input id="edit-last-name" name="last_name" value="{{ .Employee.LastName }}" required class="{{ if index .EmployeeMissingProfileFieldSet "Last Name" }}input-missing{{ end }}">
                </div>
              </div>

              <div class="edit-form-grid two-col">
                <div>
                  <label for="edit-email" class="{{ if index .EmployeeMissingProfileFieldSet "Email" }}label-missing{{ end }}">Email</label>
                  <input id="edit-email" name="email" type="email" value="{{ .Employee.Email }}" class="{{ if index .EmployeeMissingProfileFieldSet "Email" }}input-missing{{ end }}">
                </div>
                <div>
                  <label for="edit-phone" class="{{ if index .EmployeeMissingProfileFieldSet "Phone" }}label-missing{{ end }}">Phone</label>
                  <input id="edit-phone" name="phone" value="{{ .Employee.Phone }}" class="{{ if index .EmployeeMissingProfileFieldSet "Phone" }}input-missing{{ end }}">
                </div>
              </div>

              <div class="edit-form-grid two-col">
                <div>
                  <label class="{{ if index .EmployeeMissingProfileFieldSet "Birthday" }}label-missing{{ end }}">Birthday</label>
                  <div class="edit-form-grid three-col">
                    <div>
                      <label for="edit-birthday-month" class="text-muted" style="margin-bottom:0.25rem;">Month</label>
                      <select id="edit-birthday-month" name="birthday_month" data-selected="{{ .EmployeeBirthMonthInput }}" class="{{ if index .EmployeeMissingProfileFieldSet "Birthday" }}input-missing{{ end }}"></select>
                    </div>
                    <div>
                      <label for="edit-birthday-day" class="text-muted" style="margin-bottom:0.25rem;">Day</label>
                      <select id="edit-birthday-day" name="birthday_day" data-selected="{{ .EmployeeBirthDayInput }}" class="{{ if index .EmployeeMissingProfileFieldSet "Birthday" }}input-missing{{ end }}"></select>
                    </div>
                    <div>
                      <label for="edit-birthday-year" class="text-muted" style="margin-bottom:0.25rem;">Year</label>
                      <select id="edit-birthday-year" name="birthday_year" data-selected="{{ .EmployeeBirthYearInput }}" class="{{ if index .EmployeeMissingProfileFieldSet "Birthday" }}input-missing{{ end }}"></select>
                    </div>
                  </div>
                </div>
                <div>
                  <label for="edit-address" class="{{ if index .EmployeeMissingProfileFieldSet "Address" }}label-missing{{ end }}">Address</label>
                  <input id="edit-address" name="address" value="{{ .Employee.Address }}" class="{{ if index .EmployeeMissingProfileFieldSet "Address" }}input-missing{{ end }}">
                </div>
              </div>

              <div class="edit-form-grid three-col">
                <div>
                  <label for="edit-apt-number">Apt Number</label>
                  <input id="edit-apt-number" name="apt_number" value="{{ .Employee.AptNumber }}">
                </div>
                <div>
                  <label for="edit-city" class="{{ if index .EmployeeMissingProfileFieldSet "City" }}label-missing{{ end }}">City</label>
                  <input id="edit-city" name="city" value="{{ .Employee.City }}" class="{{ if index .EmployeeMissingProfileFieldSet "City" }}input-missing{{ end }}">
                </div>
                <div>
                  <label for="edit-state" class="{{ if index .EmployeeMissingProfileFieldSet "State" }}label-missing{{ end }}">State</label>
                  <input id="edit-state" name="state" value="{{ .Employee.State }}" class="{{ if index .EmployeeMissingProfileFieldSet "State" }}input-missing{{ end }}">
                </div>
              </div>

              <div class="edit-form-grid two-col">
                <div>
                  <label for="edit-zip-code" class="{{ if index .EmployeeMissingProfileFieldSet "Zip Code" }}label-missing{{ end }}">Zip Code</label>
                  <input id="edit-zip-code" name="zip_code" value="{{ .Employee.ZipCode }}" class="{{ if index .EmployeeMissingProfileFieldSet "Zip Code" }}input-missing{{ end }}">
                </div>
                <div></div>
              </div>

              <div class="edit-form-grid two-col">
                <div>
                  <label for="edit-pay-type">Pay Type (from Pay Band)</label>
                  <input id="edit-pay-type" value="{{ .Employee.PayType }}" disabled>
                </div>
                <div>
                  <label for="edit-pay-amount">Base Pay Amount (from Pay Band)</label>
                  <input id="edit-pay-amount" value="{{ .EmployeePayAmountInput }}" disabled>
                </div>
              </div>

              <div class="button-row">
                <button type="submit" class="btn btn-primary">Save Employee Details</button>
              </div>
            </form>
          </section>

          <div class="section-stack">
            <section class="section-card">
              <h2 class="section-card-title">Role Assignment</h2>
              <p class="section-card-sub">Manage department, pay band, and stacked additional compensations.</p>
              <div class="field-grid">
                <div>
                  <label for="department-name" class="{{ if index .EmployeeMissingProfileFieldSet "Department" }}label-missing{{ end }}">Department</label>
                  <select id="department-name" {{ if not .LocationDepartments }}disabled{{ end }} class="{{ if index .EmployeeMissingProfileFieldSet "Department" }}input-missing{{ end }}">
                    <option value="">Select department</option>
                    {{ $currentDepartment := .Employee.Department }}
                    {{ range .LocationDepartments }}
                      <option value="{{ .Name }}" {{ if eq .Name $currentDepartment }}selected{{ end }}>{{ .Name }}</option>
                    {{ end }}
                  </select>
                </div>
                <div>
                  <label for="job-id" class="{{ if index .EmployeeMissingProfileFieldSet "Pay Band" }}label-missing{{ end }}">Pay Band</label>
                  <select id="job-id" {{ if not .LocationJobs }}disabled{{ end }} class="{{ if index .EmployeeMissingProfileFieldSet "Pay Band" }}input-missing{{ end }}">
                    <option value="">Select pay band</option>
                    {{ $currentJobID := .Employee.JobID }}
                    {{ range .LocationJobs }}
                      <option
                        value="{{ .ID }}"
                        {{ if eq .ID $currentJobID }}selected{{ end }}
                      >{{ .Name }} ({{ if eq .PayType "salary" }}Salary{{ else }}Hourly{{ end }} / {{ .PayAmountCents }} cents)</option>
                    {{ end }}
                  </select>
                </div>
              </div>
              <div class="field-grid">
                <div>
                  <label>Base Pay</label>
                  <input value="{{ .Employee.PayAmountCents }} cents" disabled>
                </div>
                <div>
                  <label>Total Pay After Additional Compensation</label>
                  <input value="{{ .Employee.EffectivePayCents }} cents" disabled>
                </div>
              </div>
              <div style="margin-top:.75rem;">
                <label style="margin-bottom:.35rem;">Additional Compensations</label>
                {{ if .EmployeeAdditionalCompensations }}
                  <div class="table-wrap" style="margin-bottom:.75rem;">
                    <table>
                      <thead><tr><th>Label</th><th>Amount</th><th>Created</th><th>Action</th></tr></thead>
                      <tbody>
                        {{ range .EmployeeAdditionalCompensations }}
                          <tr>
                            <td>{{ .Label }}</td>
                            <td>{{ .AmountCents }} cents</td>
                            <td>{{ .CreatedAt }}</td>
                            <td>
                              <form method="post" action="/admin/locations/{{ $.Location.Number }}/employees/{{ $.Employee.TimePunchName }}/additional-compensations/{{ .ID }}/delete" onsubmit="return confirm('Delete this additional compensation?');">
                                <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                                <button class="btn btn-secondary btn-sm" type="submit">Delete</button>
                              </form>
                            </td>
                          </tr>
                        {{ end }}
                      </tbody>
                    </table>
                  </div>
                {{ else }}
                  <p class="hint" style="margin-bottom:.65rem;">No additional compensations yet.</p>
                {{ end }}
                <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/additional-compensations/add/create" class="field-grid">
                  <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                  <div>
                    <label for="additional-comp-label">Label</label>
                    <input id="additional-comp-label" name="label" placeholder="Shift Lead Premium" required>
                  </div>
                  <div>
                    <label for="additional-comp-amount">Amount (dollars)</label>
                    <input id="additional-comp-amount" name="amount" type="number" step="0.01" min="0.01" placeholder="1.50" required>
                  </div>
                  <div class="button-row" style="grid-column:1/-1;">
                    <button class="btn btn-secondary btn-sm" type="submit">Add Additional Compensation</button>
                  </div>
                </form>
              </div>
              <div id="message" class="message">{{ if .SuccessMessage }}{{ .SuccessMessage }}{{ end }}{{ if .Error }}{{ .Error }}{{ end }}</div>
            </section>

            <section class="section-card">
              <h2 class="section-card-title">Access</h2>
              <p class="section-card-sub">Set or replace the team member clock-in PIN.</p>
              <label for="clock-in-pin" class="{{ if index .EmployeeMissingProfileFieldSet "Clock In PIN" }}label-missing{{ end }}">Clock In PIN</label>
              <input id="clock-in-pin" type="text" inputmode="numeric" pattern="[0-9]{5,6}" minlength="5" maxlength="6" autocomplete="off" placeholder="{{ if .Employee.HasClockInPIN }}Enter new PIN to replace existing{{ else }}Set a 5-6 digit PIN{{ end }}" class="{{ if index .EmployeeMissingProfileFieldSet "Clock In PIN" }}input-missing{{ end }}">
              {{ if index .EmployeeMissingProfileFieldSet "Clock In PIN" }}
              <p class="notice error">Clock in PIN is required for employees with completed paperwork.</p>
              {{ end }}
              <div class="button-row" style="margin-top:0.625rem;">
                <button id="save-clock-in-pin" type="button" class="btn btn-secondary btn-sm">Save Clock In PIN</button>
                <span id="clock-in-pin-status" class="hint">{{ if .Employee.HasClockInPIN }}Clock in PIN is set.{{ else }}No clock in PIN assigned yet.{{ end }}</span>
              </div>
              <div class="button-row" style="margin-top:0.625rem;">
                <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/login-as-team">
                  <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                  <button type="submit" class="btn btn-secondary btn-sm" {{ if not .Employee.HasClockInPIN }}disabled{{ end }}>Log In as Team Member</button>
                </form>
                <span class="hint">{{ if .Employee.HasClockInPIN }}Start a team portal session as this employee for quick testing.{{ else }}Set a clock-in PIN first to enable team login.{{ end }}</span>
              </div>
            </section>

            <section class="section-card">
              <h2 class="section-card-title">Profile Photo</h2>
              <p class="section-card-sub">Upload, crop, and save the employee photo.</p>
              <div class="preview-row">
                <div class="preview-box">
                  <span class="preview-label">Selected Image</span>
                  <div class="crop-stage">
                    <img id="photo-preview" class="photo-preview" src="{{ if .Employee.HasPhoto }}/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/photo{{ else }}data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23888888' font-family='Manrope' font-size='14'%3ENo Photo%3C%2Ftext%3E%3C%2Fsvg%3E{{ end }}" alt="Profile photo">
                    <div id="crop-selection" class="crop-selection">
                      <div id="crop-handle" class="crop-handle"></div>
                    </div>
                  </div>
                </div>
                <div id="crop-result-box" class="preview-box crop-result-box">
                  <span class="preview-label">Cropped Result</span>
                  <canvas id="crop-result" class="photo-preview" width="180" height="180"></canvas>
                </div>
              </div>
              <form id="photo-form" class="controls" method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/photo" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                <input type="hidden" id="crop_x" name="crop_x" value="0">
                <input type="hidden" id="crop_y" name="crop_y" value="0">
                <input type="hidden" id="crop_size" name="crop_size" value="0">
                <input id="photo_file" type="file" name="photo_file" accept="image/png,image/jpeg,image/webp" required>
                <div id="crop-tools" class="crop-tools">
                  <p class="hint" style="margin:0;">Drag the crop box. Use the bottom-right handle to resize.</p>
                  <div class="button-row">
                    <button id="confirm-crop" type="button" class="btn btn-secondary btn-sm">Confirm Crop</button>
                    <button id="upload-photo-btn" type="submit" class="btn btn-primary btn-sm" disabled>Upload Photo</button>
                    <button id="cancel-upload" type="button" class="btn btn-secondary btn-sm">Cancel Upload</button>
                  </div>
                </div>
              </form>
              <button id="generate-link" type="button" class="btn btn-secondary btn-sm" style="margin-top:0.625rem;">Generate Secure Upload Link</button>
              <div id="upload-link-box" class="upload-link-box"></div>
            </section>

            <section class="section-card">
              <h2 class="section-card-title">Termination</h2>
              <p class="section-card-sub">Terminate this employee to move them out of the active list and into Terminated Employees.</p>
              <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/terminate" onsubmit="return confirm('Terminate this employee? They will be removed from active employees and moved to terminated employees.');">
                <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                <button type="submit" class="btn btn-secondary btn-sm" style="border-color: var(--danger); color: var(--danger);">Terminate Employee</button>
              </form>
            </section>
          </div>
        </section>
        {{ end }}

        {{ if not .IsNewHireEmployee }}
        <section class="panel" data-panel="paperwork-upload">
          <label style="margin-bottom:0.5rem;">{{ if .IsNewHireEmployee }}Employee Paperwork Link{{ else if .IsActiveEmployee }}Update Paperwork Link{{ else }}Employee Paperwork{{ end }}</label>
          {{ if .IsArchivedEmployee }}
            <p class="hint">Terminated employees do not have access to paperwork submission links.</p>
          {{ else }}
            <div style="margin-bottom:0.625rem;">
              <div class="copy-row">
                <input id="paperwork-link-input" type="text" value="{{ .EmployeePaperworkLink }}" readonly>
                <button id="copy-paperwork-link" class="btn btn-secondary btn-sm" type="button">Copy Link</button>
                <button id="view-paperwork-link" class="btn btn-secondary btn-sm" type="button">View Form</button>
              </div>
              <div id="paperwork-link-box" class="upload-link-box"></div>
            </div>
            {{ if .IsNewHireEmployee }}
              <p class="hint">Send this link to complete new-hire paperwork.</p>
            {{ else if .IsActiveEmployee }}
              <p class="hint">Send this update link to resubmit paperwork. Previous versions remain in employee files for audit history.</p>
            {{ end }}
            {{ if .CanManualPaperworkUpload }}
              <div class="paperwork-cards" style="margin-top:0.75rem;">
                <article class="paperwork-card">
                  <p class="paperwork-card-title">Manual I-9 Upload</p>
                  <p class="paperwork-meta">Upload a completed I-9 PDF directly to this employee file.</p>
                  <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/i9" enctype="multipart/form-data" style="display:grid;gap:0.5rem;">
                    <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                    <input type="file" name="i9_file" accept="application/pdf" required>
                    <button class="btn btn-secondary btn-sm" type="submit">Upload I-9 PDF</button>
                  </form>
                </article>

                <article class="paperwork-card">
                  <p class="paperwork-card-title">Manual W-4 Upload</p>
                  <p class="paperwork-meta">Upload a completed W-4 PDF directly to this employee file.</p>
                  <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/w4" enctype="multipart/form-data" style="display:grid;gap:0.5rem;">
                    <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                    <input type="file" name="w4_file" accept="application/pdf" required>
                    <button class="btn btn-secondary btn-sm" type="submit">Upload W-4 PDF</button>
                  </form>
                </article>

                <article class="paperwork-card">
                  <p class="paperwork-card-title">Other Paperwork Upload</p>
                  <p class="paperwork-meta">Upload additional supporting paperwork (PDF or image).</p>
                  <form method="post" action="/admin/locations/{{ .Location.Number }}/employees/{{ .Employee.TimePunchName }}/i9/documents" enctype="multipart/form-data" style="display:grid;gap:0.5rem;">
                    <input type="hidden" name="csrf_token" value="{{ .CSRF }}">
                    <input type="text" name="document_title" placeholder="Document title (optional)">
                    <select name="list_type">
                      <option value="other">Other</option>
                      <option value="a">List A</option>
                      <option value="b">List B</option>
                      <option value="c">List C</option>
                    </select>
                    <input type="file" name="document_file" accept="application/pdf,image/png,image/jpeg,image/webp" required>
                    <button class="btn btn-secondary btn-sm" type="submit">Upload Supporting Document</button>
                  </form>
                </article>
              </div>
            {{ else }}
              <p class="hint" style="color: var(--danger); margin-top:0.625rem;">Manual paperwork upload is blocked until all required employee fields are complete.</p>
              <p class="hint" style="margin-top:0.25rem;">Missing fields: {{ range $idx, $field := .ManualPaperworkUploadMissing }}{{ if $idx }}, {{ end }}{{ $field }}{{ end }}</p>
            {{ end }}
          {{ end }}
        </section>
        {{ end }}

        {{ if not .IsNewHireEmployee }}
        <section class="panel" data-panel="paperwork-view">
          <label style="margin-bottom:0.5rem;">View Employee Paperwork</label>
          <div class="paperwork-cards">
            {{ if and .EmployeeI9 .EmployeeI9.HasFile }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">I-9 Form</p>
                <p class="paperwork-meta">Document Title: {{ .EmployeeI9.FileName }}</p>
                <div class="paperwork-actions">
                  <a class="doc-link" href="/admin/locations/{{ .Location.Number }}/employees{{ if .IsArchivedEmployee }}/archived{{ end }}/{{ .Employee.TimePunchName }}/i9/file" target="_blank" rel="noreferrer">View Document</a>
                </div>
              </article>
            {{ else }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">I-9 Form</p>
                <p class="paperwork-meta">No I-9 uploaded yet.</p>
              </article>
            {{ end }}
            {{ if .EmployeeI9History }}
              {{ range .EmployeeI9History }}
                <article class="paperwork-card">
                  <p class="paperwork-card-title">I-9 Previous Version</p>
                  <p class="paperwork-meta">Document Title: {{ .FileName }}</p>
                  <p class="paperwork-meta">Submitted: {{ .CreatedAt }}</p>
                  <div class="paperwork-actions">
                    <a class="doc-link" href="/admin/locations/{{ $.Location.Number }}/employees/{{ $.Employee.TimePunchName }}/i9/file?version_id={{ .ID }}" target="_blank" rel="noreferrer">View Previous Version</a>
                  </div>
                </article>
              {{ end }}
            {{ end }}

            {{ if and .EmployeeW4 .EmployeeW4.HasFile }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">W-4 Form</p>
                <p class="paperwork-meta">Document Title: {{ .EmployeeW4.FileName }}</p>
                <div class="paperwork-actions">
                  <a class="doc-link" href="/admin/locations/{{ .Location.Number }}/employees{{ if .IsArchivedEmployee }}/archived{{ end }}/{{ .Employee.TimePunchName }}/w4/file" target="_blank" rel="noreferrer">View Document</a>
                </div>
              </article>
            {{ else }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">W-4 Form</p>
                <p class="paperwork-meta">No W-4 uploaded yet.</p>
              </article>
            {{ end }}
            {{ if .EmployeeW4History }}
              {{ range .EmployeeW4History }}
                <article class="paperwork-card">
                  <p class="paperwork-card-title">W-4 Previous Version</p>
                  <p class="paperwork-meta">Document Title: {{ .FileName }}</p>
                  <p class="paperwork-meta">Submitted: {{ .CreatedAt }}</p>
                  <div class="paperwork-actions">
                    <a class="doc-link" href="/admin/locations/{{ $.Location.Number }}/employees/{{ $.Employee.TimePunchName }}/w4/file?version_id={{ .ID }}" target="_blank" rel="noreferrer">View Previous Version</a>
                  </div>
                </article>
              {{ end }}
            {{ end }}

            {{ if .EmployeeScorecards }}
              {{ range .EmployeeScorecards }}
                <article class="paperwork-card">
                  <p class="paperwork-card-title">Interview Scorecard</p>
                  <p class="paperwork-meta">Candidate: {{ .FirstName }} {{ .LastName }}</p>
                  <p class="paperwork-meta">Status: {{ .Status }}</p>
                  <div class="paperwork-actions">
                    <a class="doc-link" href="/admin/locations/{{ $.Location.Number }}/candidates/{{ .ID }}/scorecard" target="_blank" rel="noreferrer">View Scorecard</a>
                  </div>
                </article>
              {{ end }}
            {{ else }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">Interview Scorecard</p>
                <p class="paperwork-meta">No scorecards available for this employee.</p>
              </article>
            {{ end }}

            {{ if .EmployeeI9Documents }}
              {{ range .EmployeeI9Documents }}
                <article class="paperwork-card">
                  <p class="paperwork-card-title">I-9 Supporting Document{{ if .ListType }} ({{ if eq .ListType "a" }}List A{{ else if eq .ListType "b" }}List B{{ else if eq .ListType "c" }}List C{{ else if eq .ListType "signature" }}Signature{{ else }}{{ .ListType }}{{ end }}){{ end }}</p>
                  <p class="paperwork-meta">Document Title: {{ .FileName }}</p>
                  <div class="paperwork-actions">
                    <a class="doc-link" href="/admin/locations/{{ $.Location.Number }}/employees{{ if $.IsArchivedEmployee }}/archived{{ end }}/{{ $.Employee.TimePunchName }}/i9/documents/{{ .ID }}" target="_blank" rel="noreferrer">View Document</a>
                    {{ if not $.IsArchivedEmployee }}
                      <form method="post" action="/admin/locations/{{ $.Location.Number }}/employees/{{ $.Employee.TimePunchName }}/i9/documents/{{ .ID }}/delete" onsubmit="return confirm('Delete this document?');">
                        <input type="hidden" name="csrf_token" value="{{ $.CSRF }}">
                        <button class="btn btn-secondary btn-sm" type="submit">Delete</button>
                      </form>
                    {{ end }}
                  </div>
                </article>
              {{ end }}
            {{ else }}
              <article class="paperwork-card">
                <p class="paperwork-card-title">I-9 Supporting Documents</p>
                <p class="paperwork-meta">No I-9 supporting documents uploaded yet.</p>
              </article>
            {{ end }}
          </div>
        </section>
        {{ end }}

      </div>
    </div>
  </div>

  {{ if not .IsArchivedEmployee }}
  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const locationNumber = "{{ .Location.Number }}";
    const timePunchName = "{{ .Employee.TimePunchName }}";
    const departmentSelect = document.getElementById("department-name");
    const jobSelect = document.getElementById("job-id");
    const message = document.getElementById("message");
    const clockInPinInput = document.getElementById("clock-in-pin");
    const saveClockInPinBtn = document.getElementById("save-clock-in-pin");
    const clockInPinStatus = document.getElementById("clock-in-pin-status");
    const preview = document.getElementById("photo-preview");
    const photoFile = document.getElementById("photo_file");
    const cropSelection = document.getElementById("crop-selection");
    const cropHandle = document.getElementById("crop-handle");
    const cropX = document.getElementById("crop_x");
    const cropY = document.getElementById("crop_y");
    const cropSize = document.getElementById("crop_size");
    const cropTools = document.getElementById("crop-tools");
    const cropResultBox = document.getElementById("crop-result-box");
    const cropCanvas = document.getElementById("crop-result");
    const cropCtx = cropCanvas ? cropCanvas.getContext("2d") : null;
    const confirmCropBtn = document.getElementById("confirm-crop");
    const uploadPhotoBtn = document.getElementById("upload-photo-btn");
    const cancelUploadBtn = document.getElementById("cancel-upload");
    const generateLinkBtn = document.getElementById("generate-link");
    const uploadLinkBox = document.getElementById("upload-link-box");
    const paperworkLinkInput = document.getElementById("paperwork-link-input");
    const copyPaperworkLinkBtn = document.getElementById("copy-paperwork-link");
    const viewPaperworkLinkBtn = document.getElementById("view-paperwork-link");
    const paperworkLinkBox = document.getElementById("paperwork-link-box");
    const paperworkButtons = Array.from(document.querySelectorAll(".paperwork-btn"));
    const paperworkCards = Array.from(document.querySelectorAll(".paperwork-form-card"));
    const i9SignaturePad = document.getElementById("i9-signature-pad");
    const i9SignatureUseBtn = document.getElementById("i9-signature-use");
    const i9SignatureClearBtn = document.getElementById("i9-signature-clear");
    const i9SignatureHidden = document.getElementById("i9_employee_signature_drawn");
    const i9SignatureText = document.getElementById("i9_employee_signature");
    const i9SignatureStatus = document.getElementById("i9-signature-status");
    const i9FormMain = document.getElementById("i9-form-main");
    const w4FormMain = document.getElementById("w4-form-main");
    const editBirthdayMonth = document.getElementById("edit-birthday-month");
    const editBirthdayDay = document.getElementById("edit-birthday-day");
    const editBirthdayYear = document.getElementById("edit-birthday-year");
    const originalPreviewSrc = preview ? (preview.getAttribute("src") || "") : "";
    let naturalWidth = 0;
    let naturalHeight = 0;
    let fileSelected = false;
    let cropRect = { x: 0, y: 0, size: 0 };
    let dragMode = "";
    let pointerStart = { x: 0, y: 0 };
    let rectStart = { x: 0, y: 0, size: 0 };
    let cropConfirmed = false;
    let cropLocked = false;
    let i9HasInk = false;

    function populateBirthdaySelect(select, min, max, selectedValue, pad) {
      if (!select) return;
      const selectedNumber = Number.parseInt((selectedValue || "").trim(), 10);
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select";
      select.appendChild(placeholder);
      for (let value = min; value <= max; value += 1) {
        const option = document.createElement("option");
        option.value = String(value);
        option.textContent = pad ? String(value).padStart(2, "0") : String(value);
        if (Number.isFinite(selectedNumber) && value === selectedNumber) {
          option.selected = true;
        }
        select.appendChild(option);
      }
    }

    if (editBirthdayMonth && editBirthdayDay && editBirthdayYear) {
      populateBirthdaySelect(editBirthdayMonth, 1, 12, editBirthdayMonth.dataset.selected || "", true);
      populateBirthdaySelect(editBirthdayDay, 1, 31, editBirthdayDay.dataset.selected || "", true);
      const nowYear = new Date().getFullYear();
      populateBirthdaySelect(editBirthdayYear, 1900, nowYear + 1, editBirthdayYear.dataset.selected || "", false);
    }

    if (jobSelect) {
      jobSelect.disabled = false;
    }

    if (departmentSelect) {
      departmentSelect.addEventListener("change", async () => {
        const previous = departmentSelect.dataset.prev || departmentSelect.defaultValue || "";
        const nextDepartment = (departmentSelect.value || "").trim();
        if (!nextDepartment) {
          message.textContent = "Please select a department.";
          message.className = "message error";
          departmentSelect.value = previous;
          return;
        }
        departmentSelect.disabled = true;
        message.textContent = "";
        message.className = "message";
        try {
          const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/employees/${encodeURIComponent(timePunchName)}/department`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify({ department: nextDepartment })
          });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.error || "Unable to update department.");
          }
          departmentSelect.dataset.prev = nextDepartment;
          departmentSelect.defaultValue = nextDepartment;
          message.textContent = "Department updated.";
          message.classList.add("ok");
        } catch (error) {
          departmentSelect.value = previous;
          message.textContent = error.message || "Unable to update department.";
          message.classList.add("error");
        } finally {
          departmentSelect.disabled = false;
        }
      });
    }

    if (jobSelect && message) {
      jobSelect.addEventListener("change", async () => {
        const previous = jobSelect.dataset.prev || jobSelect.defaultValue || "";
        const nextJobID = (jobSelect.value || "").trim();
        if (!nextJobID) {
          message.textContent = "Please select a pay band.";
          message.className = "message error";
          jobSelect.value = previous;
          return;
        }
        jobSelect.disabled = true;
        message.textContent = "";
        message.className = "message";
        try {
          const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/employees/${encodeURIComponent(timePunchName)}/pay-band`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify({ payBandId: Number(nextJobID) })
          });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.error || "Unable to update pay band.");
          }
          jobSelect.dataset.prev = nextJobID;
          jobSelect.defaultValue = nextJobID;
          message.textContent = "Pay band updated.";
          message.classList.add("ok");
        } catch (error) {
          jobSelect.value = previous;
          message.textContent = error.message || "Unable to update pay band.";
          message.classList.add("error");
        } finally {
          jobSelect.disabled = false;
        }
      });
    }

    if (saveClockInPinBtn && clockInPinInput && clockInPinStatus) {
      clockInPinInput.addEventListener("input", () => {
        clockInPinInput.value = (clockInPinInput.value || "").replace(/\D+/g, "").slice(0, 6);
      });
      saveClockInPinBtn.addEventListener("click", async () => {
        const pin = (clockInPinInput.value || "").replace(/\D+/g, "").slice(0, 6);
        clockInPinInput.value = pin;
        if (!/^\d{5,6}$/.test(pin)) {
          clockInPinStatus.textContent = "PIN must be 5 or 6 digits.";
          return;
        }
        saveClockInPinBtn.disabled = true;
        clockInPinStatus.textContent = "Saving...";
        try {
          const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/employees/${encodeURIComponent(timePunchName)}/clock-in-pin`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify({ pin })
          });
          const raw = await response.text();
          let result = {};
          try { result = raw ? JSON.parse(raw) : {}; } catch (_) {}
          if (!response.ok) {
            const fallback = typeof raw === "string" ? raw.trim() : "";
            throw new Error(result.error || fallback || "Unable to save clock in PIN.");
          }
          clockInPinInput.value = "";
          clockInPinStatus.textContent = "Clock in PIN saved. Reloading...";
          window.location.reload();
        } catch (error) {
          clockInPinStatus.textContent = error.message || "Unable to save clock in PIN.";
        } finally {
          saveClockInPinBtn.disabled = false;
        }
      });
    }

    function syncCropHiddenFields() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (displayWidth <= 0 || displayHeight <= 0 || naturalWidth <= 0 || naturalHeight <= 0) return;
      const scaleX = naturalWidth / displayWidth;
      const scaleY = naturalHeight / displayHeight;
      cropX.value = String(Math.round(cropRect.x * scaleX));
      cropY.value = String(Math.round(cropRect.y * scaleY));
      cropSize.value = String(Math.round(cropRect.size * Math.min(scaleX, scaleY)));
    }

    function renderCropSelection() {
      cropSelection.style.left = `${cropRect.x}px`;
      cropSelection.style.top = `${cropRect.y}px`;
      cropSelection.style.width = `${cropRect.size}px`;
      cropSelection.style.height = `${cropRect.size}px`;
    }

    function setCropModeActive(active) {
      cropTools.classList.toggle("is-active", active);
      cropResultBox.classList.toggle("is-active", active);
      cropSelection.classList.toggle("is-active", active);
      if (!active && cropCtx) {
        cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
      }
      setCropConfirmed(false);
    }

    function setCropConfirmed(value) {
      cropConfirmed = value;
      cropLocked = value;
      cropSelection.classList.toggle("is-locked", value);
      uploadPhotoBtn.disabled = !value;
      confirmCropBtn.textContent = value ? "Crop Confirmed" : "Confirm Crop";
    }

    function cancelUpload() {
      fileSelected = false;
      photoFile.value = "";
      naturalWidth = 0;
      naturalHeight = 0;
      cropX.value = "0";
      cropY.value = "0";
      cropSize.value = "0";
      setCropModeActive(false);
      cropSelection.classList.remove("is-active");
      if (originalPreviewSrc !== "") {
        preview.src = originalPreviewSrc;
      }
      setCropConfirmed(false);
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function drawCropPreview() {
      if (!cropCtx || naturalWidth <= 0 || naturalHeight <= 0) return;
      syncCropHiddenFields();
      const size = Number(cropSize.value || "0");
      const x = Number(cropX.value || "0");
      const y = Number(cropY.value || "0");
      if (size <= 0) return;
      cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
      cropCtx.drawImage(preview, x, y, size, size, 0, 0, cropCanvas.width, cropCanvas.height);
    }

    function initializeCropControls() {
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      const minDim = Math.min(displayWidth, displayHeight);
      const initial = Math.max(48, Math.floor(minDim * 0.72));
      cropRect.size = Math.min(initial, minDim);
      cropRect.x = Math.floor((displayWidth - cropRect.size) / 2);
      cropRect.y = Math.floor((displayHeight - cropRect.size) / 2);
      renderCropSelection();
      drawCropPreview();
    }

    function onPointerMove(event) {
      if (!dragMode || cropLocked) return;
      const dx = event.clientX - pointerStart.x;
      const dy = event.clientY - pointerStart.y;
      const displayWidth = preview.clientWidth || 0;
      const displayHeight = preview.clientHeight || 0;
      if (dragMode === "move") {
        cropRect.x = clamp(rectStart.x + dx, 0, displayWidth - rectStart.size);
        cropRect.y = clamp(rectStart.y + dy, 0, displayHeight - rectStart.size);
      } else if (dragMode === "resize") {
        const maxSize = Math.min(displayWidth - rectStart.x, displayHeight - rectStart.y);
        cropRect.size = clamp(rectStart.size + Math.max(dx, dy), 48, maxSize);
      }
      setCropConfirmed(false);
      renderCropSelection();
      drawCropPreview();
      event.preventDefault();
    }

    function onPointerUp() {
      dragMode = "";
      window.removeEventListener("pointermove", onPointerMove);
      window.removeEventListener("pointerup", onPointerUp);
    }

    if (preview && photoFile && cropSelection && cropHandle && cropX && cropY && cropSize && cropTools && cropResultBox && cropCanvas && cropCtx && confirmCropBtn && uploadPhotoBtn && cancelUploadBtn && generateLinkBtn && uploadLinkBox) {
      cropSelection.addEventListener("pointerdown", (event) => {
        if (!fileSelected || cropLocked) return;
        dragMode = event.target === cropHandle ? "resize" : "move";
        pointerStart = { x: event.clientX, y: event.clientY };
        rectStart = { x: cropRect.x, y: cropRect.y, size: cropRect.size };
        window.addEventListener("pointermove", onPointerMove);
        window.addEventListener("pointerup", onPointerUp);
        event.preventDefault();
      });

      photoFile.addEventListener("change", () => {
        const file = photoFile.files && photoFile.files[0];
        if (!file) {
          cancelUpload();
          return;
        }
        fileSelected = true;
        setCropModeActive(true);
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
        };
        reader.readAsDataURL(file);
      });

      preview.addEventListener("load", () => {
        if (!fileSelected) return;
        naturalWidth = preview.naturalWidth || 0;
        naturalHeight = preview.naturalHeight || 0;
        if (naturalWidth > 0 && naturalHeight > 0) {
          initializeCropControls();
        }
        setCropConfirmed(false);
      });

      confirmCropBtn.addEventListener("click", () => {
        if (!fileSelected) return;
        drawCropPreview();
        setCropConfirmed(true);
      });
      cancelUploadBtn.addEventListener("click", cancelUpload);
      setCropModeActive(false);

      generateLinkBtn.addEventListener("click", async () => {
        uploadLinkBox.textContent = "";
        try {
          const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/employees/${encodeURIComponent(timePunchName)}/photo-link`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            body: "{}"
          });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.error || "Unable to generate link.");
          }
          uploadLinkBox.innerHTML = `Share this link with employee:<br><a href="${result.uploadLink}" target="_blank" rel="noreferrer">${result.uploadLink}</a>`;
        } catch (error) {
          uploadLinkBox.textContent = error.message || "Unable to generate link.";
        }
      });
    }

    if (copyPaperworkLinkBtn && paperworkLinkInput) {
      copyPaperworkLinkBtn.addEventListener("click", async () => {
        paperworkLinkBox.textContent = "";
        const value = paperworkLinkInput.value || "";
        if (!value) return;
        try {
          await navigator.clipboard.writeText(value);
          paperworkLinkBox.textContent = "Paperwork link copied.";
        } catch (error) {
          paperworkLinkInput.focus();
          paperworkLinkInput.select();
          paperworkLinkBox.textContent = "Copy failed. Link is selected so you can copy manually.";
        }
      });
    }
    if (viewPaperworkLinkBtn && paperworkLinkInput) {
      viewPaperworkLinkBtn.addEventListener("click", () => {
        const value = paperworkLinkInput.value || "";
        if (value) {
          window.location.href = value;
        }
      });
    }

    function showPaperworkForm(targetId) {
      paperworkButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.paperworkForm === targetId));
      paperworkCards.forEach((card) => card.classList.toggle("active", card.id === targetId));
    }
    paperworkButtons.forEach((btn) => {
      btn.addEventListener("click", () => showPaperworkForm(btn.dataset.paperworkForm));
    });
    if (paperworkButtons.length > 0 && paperworkCards.length > 0) {
      showPaperworkForm("i9-form-card");
    }

    function digitsOnly(value) {
      return (value || "").replace(/\D+/g, "");
    }
    function setupSegmentedInputs(ids) {
      const inputs = ids.map((id) => document.getElementById(id)).filter(Boolean);
      inputs.forEach((input, index) => {
        input.addEventListener("input", () => {
          input.value = digitsOnly(input.value).slice(0, Number(input.maxLength || 32));
          if (input.value.length === Number(input.maxLength || 0) && inputs[index + 1]) {
            inputs[index + 1].focus();
          }
        });
        input.addEventListener("keydown", (event) => {
          if (event.key === "Backspace" && input.value === "" && inputs[index - 1]) {
            inputs[index - 1].focus();
          }
        });
      });
    }
    setupSegmentedInputs(["admin_i9_ssn_1", "admin_i9_ssn_2", "admin_i9_ssn_3"]);
    setupSegmentedInputs(["admin_i9_phone_1", "admin_i9_phone_2", "admin_i9_phone_3"]);
    setupSegmentedInputs(["admin_w4_ssn_1", "admin_w4_ssn_2", "admin_w4_ssn_3"]);
    if (i9FormMain) {
      i9FormMain.addEventListener("submit", () => {
        const ssnHidden = document.getElementById("admin_i9_ssn");
        const phoneHidden = document.getElementById("admin_i9_phone");
        if (ssnHidden) {
          ssnHidden.value = [
            document.getElementById("admin_i9_ssn_1")?.value || "",
            document.getElementById("admin_i9_ssn_2")?.value || "",
            document.getElementById("admin_i9_ssn_3")?.value || ""
          ].map(digitsOnly).join("-");
        }
        if (phoneHidden) {
          phoneHidden.value = [
            document.getElementById("admin_i9_phone_1")?.value || "",
            document.getElementById("admin_i9_phone_2")?.value || "",
            document.getElementById("admin_i9_phone_3")?.value || ""
          ].map(digitsOnly).join("-");
        }
      });
    }
    if (w4FormMain) {
      w4FormMain.addEventListener("submit", () => {
        const ssnHidden = document.getElementById("admin_w4_ssn");
        if (ssnHidden) {
          ssnHidden.value = [
            document.getElementById("admin_w4_ssn_1")?.value || "",
            document.getElementById("admin_w4_ssn_2")?.value || "",
            document.getElementById("admin_w4_ssn_3")?.value || ""
          ].map(digitsOnly).join("-");
        }
      });
    }

    if (i9SignaturePad && i9SignatureUseBtn && i9SignatureClearBtn && i9SignatureHidden && i9FormMain) {
      const sigCtx = i9SignaturePad.getContext("2d");
      let drawing = false;
      let lastX = 0;
      let lastY = 0;
      function signatureInkColor() {
        const rootStyles = getComputedStyle(document.documentElement);
        const cssInk = (rootStyles.getPropertyValue("--sig-ink") || "").trim();
        return cssInk || "#1f232a";
      }

      function signaturePos(event) {
        const rect = i9SignaturePad.getBoundingClientRect();
        return {
          x: ((event.clientX - rect.left) * i9SignaturePad.width) / rect.width,
          y: ((event.clientY - rect.top) * i9SignaturePad.height) / rect.height
        };
      }

      function clearSignatureStatus(text) {
        if (!i9SignatureStatus) return;
        i9SignatureStatus.textContent = text;
      }

      i9SignaturePad.addEventListener("pointerdown", (event) => {
        drawing = true;
        const pos = signaturePos(event);
        lastX = pos.x;
        lastY = pos.y;
        i9SignaturePad.setPointerCapture(event.pointerId);
        event.preventDefault();
      });
      i9SignaturePad.addEventListener("pointermove", (event) => {
        if (!drawing || !sigCtx) return;
        const pos = signaturePos(event);
        sigCtx.lineCap = "round";
        sigCtx.lineJoin = "round";
        sigCtx.lineWidth = 2.4;
        sigCtx.strokeStyle = signatureInkColor();
        sigCtx.beginPath();
        sigCtx.moveTo(lastX, lastY);
        sigCtx.lineTo(pos.x, pos.y);
        sigCtx.stroke();
        lastX = pos.x;
        lastY = pos.y;
        i9HasInk = true;
        event.preventDefault();
      });
      const endDraw = () => { drawing = false; };
      i9SignaturePad.addEventListener("pointerup", endDraw);
      i9SignaturePad.addEventListener("pointercancel", endDraw);

      i9SignatureClearBtn.addEventListener("click", () => {
        if (sigCtx) {
          sigCtx.clearRect(0, 0, i9SignaturePad.width, i9SignaturePad.height);
        }
        i9HasInk = false;
        i9SignatureHidden.value = "";
        clearSignatureStatus("Signature cleared.");
      });

      i9SignatureUseBtn.addEventListener("click", () => {
        if (!i9HasInk) {
          clearSignatureStatus("Draw a signature first.");
          return;
        }
        i9SignatureHidden.value = i9SignaturePad.toDataURL("image/png");
        if (i9SignatureText && i9SignatureText.value.trim() === "") {
          i9SignatureText.value = "Digital Signature on File";
        }
        clearSignatureStatus("Drawn signature will be saved with this I-9.");
      });

      i9FormMain.addEventListener("submit", () => {
        if (i9HasInk && i9SignatureHidden.value === "") {
          i9SignatureHidden.value = i9SignaturePad.toDataURL("image/png");
          if (i9SignatureText && i9SignatureText.value.trim() === "") {
            i9SignatureText.value = "Digital Signature on File";
          }
        }
      });
    }

  </script>
  {{ end }}
  <script>
    const submenuButtons = Array.from(document.querySelectorAll(".submenu-btn"));
    const panels = Array.from(document.querySelectorAll(".panel[data-panel]"));

    function showPanel(panelName) {
      submenuButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.target === panelName));
      panels.forEach((panel) => panel.classList.toggle("active", panel.dataset.panel === panelName));
      if (window.location.hash !== "#" + panelName) {
        window.history.replaceState(null, "", "#" + panelName);
      }
    }

    submenuButtons.forEach((btn) => {
      btn.addEventListener("click", () => showPanel(btn.dataset.target));
    });

        let initialPanel = (window.location.hash || "").replace("#", "");
    if (initialPanel === "employee-view" || initialPanel === "employee-edit") {
      initialPanel = "employee";
    }
    if (initialPanel && panels.some((panel) => panel.dataset.panel === initialPanel)) {
      showPanel(initialPanel);
    } else {
      showPanel("employee");
    }
  </script>
  <script>
    (function () {
      var storageKey = "cfasuite-theme";
      var root = document.documentElement;
      var toggle = document.getElementById("theme-toggle");
      var navToggle = document.getElementById("nav-toggle");
      var navMobile = document.getElementById("nav-mobile");
      if (toggle) {
        toggle.addEventListener("click", function () {
          var isDark = root.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
        });
      }
      if (navToggle && navMobile) {
        navToggle.addEventListener("click", function () {
          var expanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", expanded ? "false" : "true");
          navMobile.classList.toggle("hidden", expanded);
          if (!expanded) { navMobile.style.display = "flex"; } else { navMobile.style.removeProperty("display"); }
        });
      }
    })();
  </script>

</body>
</html>
