<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ .CSRF }}">
  <title>Business Days</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/app.css">
  <script>
    (function () {
      var stored = localStorage.getItem("cfasuite-theme");
      var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      var theme = stored === "light" || stored === "dark" ? stored : (prefersDark ? "dark" : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    })();
  </script>
  <style>
    :root {
      --bg: #ffffff; --fg: #09090b; --card: #ffffff;
      --muted: #f4f4f5; --muted-fg: #71717a; --border: #e4e4e7;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #dc2626; --success: #16a34a;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    }
    html.dark {
      --bg: #09090b; --fg: #fafafa; --card: #09090b;
      --muted: #27272a; --muted-fg: #a1a1aa; --border: #3f3f46;
      --primary: #004f71; --primary-fg: #ffffff;
      --danger: #f87171; --success: #4ade80;
      --shadow: 0 1px 3px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background-color: var(--bg); color: var(--fg); font-family: "Manrope", ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2, h3 { margin: 0; font-family: "Space Grotesk", "Manrope", sans-serif; font-weight: 700; line-height: 1.25; }
    h1 { font-size: clamp(1.375rem, 3vw, 1.875rem); }
    h2 { font-size: 1.125rem; }
    p { margin: 0; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card, .panel { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; box-shadow: var(--shadow); }
    @media (max-width: 639px) { .card, .panel { padding: 1rem; } }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea { display: block; width: 100%; min-height: 2.375rem; padding: 0.5rem 0.75rem; font: 0.875rem/1.5 inherit; color: var(--fg); background-color: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; transition: border-color 150ms, box-shadow 150ms; }
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="submit"]):not([type="button"]):not([type="reset"]):focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    html.dark input:focus, html.dark select:focus, html.dark textarea:focus { box-shadow: 0 0 0 3px rgba(0,79,113,.15); }
    label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.375rem; }
    .text-muted { color: var(--muted-fg); font-size: 0.875rem; }
    .back { font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); display: inline-flex; align-items: center; gap: 0.25rem; margin-bottom: 1rem; }
    .back:hover { color: var(--fg); text-decoration: none; }
    .notice, .msg { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.75rem; }
    .notice.ok, .msg.ok { color: var(--success); }
    .notice.error, .msg.error { color: var(--danger); }

    .legend { margin: 1rem 0 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .legend-item { display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.8125rem; color: var(--muted-fg); }
    .legend-swatch { width: 12px; height: 12px; border-radius: 0.25rem; border: 1px solid var(--border); }
    .sw-none { background: var(--muted); }
    .sw-incomplete { background: #fef08a; }
    .sw-complete { background: #bbf7d0; }
    .sw-sunday { background: var(--muted); opacity: 0.5; }

    .calendar-head { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin: 0.75rem 0; }
    .month-label { font-weight: 700; font-size: 1rem; }
    .month-btn { background: var(--bg); border: 1px solid var(--border); color: var(--fg); border-radius: 0.375rem; min-height: 2rem; padding: 0.375rem 0.75rem; font: 500 0.875rem inherit; cursor: pointer; transition: 150ms; }
    .month-btn:hover { background-color: var(--muted); }

    .weekdays, .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 4px; }
    .weekdays div { text-align: center; font-size: 0.6875rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--muted-fg); font-weight: 600; padding: 0.25rem 0; }

    .day-cell { border: 1px solid var(--border); border-radius: 0.375rem; min-height: 56px; padding: 0.5rem; font-size: 0.875rem; background: var(--bg); text-align: left; cursor: pointer; font-weight: 500; font-family: inherit; color: var(--fg); transition: 150ms; }
    .day-cell:hover:not(:disabled) { border-color: var(--primary); background: var(--muted); }
    .day-cell.outside { visibility: hidden; pointer-events: none; }
    .day-cell.sunday, .day-cell.future { background: var(--muted); color: var(--muted-fg); cursor: not-allowed; opacity: 0.6; }
    .day-cell.status-none { background: var(--bg); }
    .day-cell.status-incomplete { background: #fef9c3; border-color: #fde68a; color: #854d0e; }
    html.dark .day-cell.status-incomplete { background: #422006; border-color: #78350f; color: #fde68a; }
    .day-cell.status-complete { background: #dcfce7; border-color: #bbf7d0; color: #14532d; }
    html.dark .day-cell.status-complete { background: #052e16; border-color: #166534; color: #bbf7d0; }
    .day-cell.today { box-shadow: inset 0 0 0 2px var(--primary); }

    .editor { margin-top: 1.25rem; border-top: 1px solid var(--border); padding-top: 1rem; display: none; }
    .editor.active { display: block; }
    .editor-title { margin: 0 0 0.75rem; font-size: 0.9375rem; font-weight: 600; }
    .editor-grid { display: grid; gap: 0.75rem; grid-template-columns: repeat(2, 1fr); max-width: 380px; }
    .editor-grid label { font-size: 0.875rem; font-weight: 600; }
    .editor-status { min-height: 1.25rem; margin-top: 0.5rem; font-size: 0.8125rem; font-weight: 500; color: var(--muted-fg); }
    .editor-status.ok { color: var(--success); }
    .editor-status.error { color: var(--danger); }
    .hint { font-size: 0.8125rem; color: var(--muted-fg); margin-top: 0.75rem; line-height: 1.5; }
  </style>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors">

  <header class="fixed inset-x-0 top-0 z-50 h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-sm transition-colors">
    <div class="mx-auto max-w-6xl h-full px-4 flex items-center justify-between gap-4">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-sm font-bold text-zinc-900 dark:text-zinc-100 shrink-0" style="text-decoration:none">CFA Suite</a>
      <nav class="hidden md:flex items-center gap-1 flex-1" id="nav-desktop">
        <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
        <a href="/admin/locations/{{ .Location.Number }}/business-days" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Business Days</a>
      </nav>
      <div class="flex items-center gap-2 shrink-0">
        <a href="/logout" class="text-xs font-semibold px-2.5 py-1.5 rounded-md border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Logout</a>
        <button id="theme-toggle" type="button" aria-label="Toggle theme" class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <svg class="h-4 w-4 block dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="h-4 w-4 hidden dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <button id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-mobile" class="md:hidden h-8 w-8 inline-flex items-center justify-center rounded-md border border-zinc-200 dark:border-zinc-700 bg-transparent text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          <span class="sr-only">Open menu</span>
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </button>
      </div>
    </div>
    <div id="nav-mobile" class="hidden md:hidden border-t border-zinc-200 dark:border-zinc-800 px-4 py-2 bg-white dark:bg-zinc-950 flex-col gap-1">
      <a href="/admin/locations/{{ .Location.Number }}" class="text-xs font-semibold px-2.5 py-1.5 rounded-md text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">Apps</a>
      <a href="/admin/locations/{{ .Location.Number }}/business-days" class="text-xs font-semibold px-2.5 py-1.5 rounded-md bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900">Business Days</a>
    </div>
  </header>

  <div class="pt-14 min-h-[calc(100vh-3.5rem)] px-4 py-8">
    <div class="mx-auto max-w-[900px]">
      <div class="card">
        <a class="back" href="/admin/locations/{{ .Location.Number }}">&#8592; Back to Apps</a>
        <h1 style="margin-bottom:0.25rem;">Business Days</h1>
        <p class="text-muted" style="margin-bottom:0.5rem;">{{ .Location.Name }} ({{ .Location.Number }})</p>
        {{ if .SuccessMessage }}<p class="notice ok">{{ .SuccessMessage }}</p>{{ end }}
        {{ if .Error }}<p class="notice error">{{ .Error }}</p>{{ end }}

        <div class="legend">
          <span class="legend-item"><span class="legend-swatch sw-none"></span>Not Created</span>
          <span class="legend-item"><span class="legend-swatch sw-incomplete"></span>Created, Incomplete</span>
          <span class="legend-item"><span class="legend-swatch sw-complete"></span>Created, Complete</span>
          <span class="legend-item"><span class="legend-swatch sw-sunday"></span>Sunday (Unavailable)</span>
        </div>

        <div class="calendar-head">
          <button id="prev-month" class="month-btn" type="button">Previous</button>
          <div id="month-label" class="month-label"></div>
          <button id="next-month" class="month-btn" type="button">Next</button>
        </div>

        <div class="weekdays">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>

        <p class="hint">Click any non-Sunday day to open its business day metrics below. If it does not exist yet, it is created automatically with sales and labor initialized to 0.</p>

        <section id="day-editor" class="editor">
          <h2 class="editor-title">Business Day: <span id="editor-date"></span></h2>
          <div class="editor-grid">
            <div>
              <label for="editor-sales">Total Sales</label>
              <input id="editor-sales" type="number" min="0" step="0.01" value="0">
            </div>
            <div>
              <label for="editor-labor">Labor Hours</label>
              <input id="editor-labor" type="number" min="0" step="0.01" value="0">
            </div>
          </div>
          <p id="editor-status" class="editor-status"></p>
        </section>
      </div>
    </div>
  </div>

  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const locationNumber = "{{ .Location.Number }}";
    const businessDays = [
      {{- range .BusinessDays }}
      {
        businessDate: "{{ .BusinessDate }}",
        totalSales: Number("{{ .TotalSales }}"),
        laborHours: Number("{{ .LaborHours }}")
      },
      {{- end }}
    ];
    const byDate = new Map();
    for (const day of businessDays) {
      byDate.set(day.businessDate, day);
    }

    const monthLabelEl = document.getElementById("month-label");
    const calendarGridEl = document.getElementById("calendar-grid");
    const prevBtn = document.getElementById("prev-month");
    const nextBtn = document.getElementById("next-month");
    const editorEl = document.getElementById("day-editor");
    const editorDateEl = document.getElementById("editor-date");
    const editorSalesEl = document.getElementById("editor-sales");
    const editorLaborEl = document.getElementById("editor-labor");
    const editorStatusEl = document.getElementById("editor-status");
    let selectedDate = "";

    const now = new Date();
    let currentYear = now.getFullYear();
    let currentMonth = now.getMonth();

    function fmtDate(year, monthIndex, day) {
      const m = String(monthIndex + 1).padStart(2, "0");
      const d = String(day).padStart(2, "0");
      return `${year}-${m}-${d}`;
    }

    function statusFor(dateStr) {
      const existing = byDate.get(dateStr);
      if (!existing) return "status-none";
      const complete = Number(existing.totalSales) > 0 && Number(existing.laborHours) > 0;
      return complete ? "status-complete" : "status-incomplete";
    }

    function setEditorStatus(message, isError) {
      editorStatusEl.textContent = message;
      editorStatusEl.className = "editor-status";
      if (message) editorStatusEl.classList.add(isError ? "error" : "ok");
    }

    async function openBusinessDay(dateStr) {
      setEditorStatus("Loading...", false);
      try {
        const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/business-days/open`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken
          },
          body: JSON.stringify({ businessDate: dateStr })
        });
        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(result.error || "Unable to open business day.");
        }
        const day = result.businessDay || {};
        selectedDate = day.businessDate || dateStr;
        editorDateEl.textContent = selectedDate;
        editorSalesEl.value = String(day.totalSales ?? 0);
        editorLaborEl.value = String(day.laborHours ?? 0);
        editorEl.classList.add("active");
        byDate.set(selectedDate, {
          businessDate: selectedDate,
          totalSales: Number(day.totalSales || 0),
          laborHours: Number(day.laborHours || 0),
          createdAt: day.createdAt || ""
        });
        renderCalendar();
        setEditorStatus("Loaded", false);
      } catch (error) {
        setEditorStatus(error.message || "Unable to open business day.", true);
      }
    }

    async function saveEditor() {
      if (!selectedDate) return;
      const payload = {
        totalSales: String(editorSalesEl.value || "").trim(),
        laborHours: String(editorLaborEl.value || "").trim()
      };
      setEditorStatus("Saving...", false);
      try {
        const response = await fetch(`/admin/locations/${encodeURIComponent(locationNumber)}/business-days/${encodeURIComponent(selectedDate)}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken
          },
          body: JSON.stringify(payload)
        });
        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(result.error || "Unable to save business day.");
        }
        byDate.set(selectedDate, {
          businessDate: selectedDate,
          totalSales: Number(payload.totalSales || 0),
          laborHours: Number(payload.laborHours || 0),
          createdAt: byDate.get(selectedDate)?.createdAt || ""
        });
        renderCalendar();
        setEditorStatus("Saved", false);
      } catch (error) {
        setEditorStatus(error.message || "Unable to save business day.", true);
      }
    }

    function renderCalendar() {
      const first = new Date(currentYear, currentMonth, 1);
      const firstWeekday = first.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const todayStr = fmtDate(now.getFullYear(), now.getMonth(), now.getDate());
      const monthName = first.toLocaleString(undefined, { month: "long", year: "numeric" });
      monthLabelEl.textContent = monthName;
      calendarGridEl.innerHTML = "";

      for (let i = 0; i < firstWeekday; i++) {
        const empty = document.createElement("button");
        empty.type = "button";
        empty.className = "day-cell outside";
        calendarGridEl.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = fmtDate(currentYear, currentMonth, day);
        const isSunday = date.getDay() === 0;
        const isFuture = dateStr > todayStr;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "day-cell";
        btn.textContent = String(day);
        if (dateStr === todayStr) btn.classList.add("today");
        if (isSunday || isFuture) {
          btn.classList.add("sunday");
          if (isFuture) btn.classList.add("future");
          btn.disabled = true;
        } else {
          btn.classList.add(statusFor(dateStr));
          btn.addEventListener("click", () => openBusinessDay(dateStr));
        }
        calendarGridEl.appendChild(btn);
      }
    }

    prevBtn.addEventListener("click", () => {
      currentMonth -= 1;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear -= 1;
      }
      renderCalendar();
    });

    nextBtn.addEventListener("click", () => {
      currentMonth += 1;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear += 1;
      }
      renderCalendar();
    });

    editorSalesEl.addEventListener("change", saveEditor);
    editorLaborEl.addEventListener("change", saveEditor);

    renderCalendar();
  </script>
  <script>
    (function () {
      var storageKey = "cfasuite-theme";
      var root = document.documentElement;
      var toggle = document.getElementById("theme-toggle");
      var navToggle = document.getElementById("nav-toggle");
      var navMobile = document.getElementById("nav-mobile");
      if (toggle) {
        toggle.addEventListener("click", function () {
          var isDark = root.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
        });
      }
      if (navToggle && navMobile) {
        navToggle.addEventListener("click", function () {
          var expanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", expanded ? "false" : "true");
          navMobile.classList.toggle("hidden", expanded);
          if (!expanded) { navMobile.style.display = "flex"; } else { navMobile.style.removeProperty("display"); }
        });
      }
    })();
  </script>
</body>
</html>
